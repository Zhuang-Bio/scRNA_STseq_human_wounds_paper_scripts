---
title: "Compare deconv methods"
author: "Åsa Björklund"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    fig_caption: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, result='hold',fig.width=12,tidy=TRUE)
knitr::opts_knit$set(progress=TRUE,verbose=TRUE)
```

Deconvolution was tested on one section Donor3_wound7

* Tangram, wih 2 different gene lists (all DEGs with FC>0.5 and adj_pval<0.01) or top100 genes per cluster
* SpatialDWLS was tested with the fc0.5_pval0.01 gene list.
* RCTD was run with default parameters, finds its own gene list.
* SCDC with fc0.5_pval0.01 gene list.

## Load

### Load packages

```{r packages}
suppressPackageStartupMessages(require(Matrix))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(gridExtra))
source("../../functions/overlap_phyper_v2.R")
```

```{r}
cl.colors = c("#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4",
    "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8",
    "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9", "#000000")
names(cl.colors) = as.character(0:20)


```


```{r, fig.height=10}
input_dir = "../../../deconv/results/"
sample = "Donor3_Wound7"

st.data = readRDS(file = "../../../spatial/results/all/all_harmony.rds")
st.data = st.data[,st.data$Sample_name == sample]

#cl.colors = cl.colors[unique(st.data$seurat_clusters)]

p1 = DimPlot(st.data, label = T, cols = cl.colors) + NoAxes() + ggtitle("Integrated clusters")
table(st.data$seurat_clusters)
p2 = SpatialDimPlot(st.data, stroke = 0,  cols = cl.colors, images = sample)
p3 = GetImage(st.data, image = sample)
grid.arrange(p1,p2,p3, ncol = 2)
```

Plotting functions

```{r}
plot.gene.umap = function(sdata, genes, reduction = "umap", assay = "Spatial", ncol=5,nrow=6, nPlot=NULL){
  cc = scale_color_gradientn(colors = c("grey","yellow","red","black"))
  small.leg <- theme(legend.text = element_text(size=6), legend.key.width = unit(0.1,"cm"))
  sdata@active.assay = assay
  pl = list()
  for (i in 1:length(genes)){
    pl[[i]] = FeaturePlot(sdata,features = genes[i], slot = "data",  pt.size = 0.01, order = T, reduction = reduction) + NoAxes() + cc + small.leg + ggtitle(genes[i]) + theme(plot.title = element_text(size=10))
  }
  if (is.null(nPlot)){ nPlot = length(genes)}
  if (nPlot > ncol*nrow){
    print("Cannot fit all figures into a single plot")
    nPlot = ncol*nrow
  }
  nBin = ceiling(length(pl)/nPlot)
  for (i in 1:nBin){
    x = (i*nPlot+1-nPlot):min(length(pl),i*nPlot)
    grid.arrange(grobs=pl[x], ncol=ncol, nrow=nrow)
  }
}

```




```{r}
plot.gene.st = function(sdata,genes,image,assay="Spatial", ncol=5,nrow=6, nPlot=NULL){
  
  tmp = data.frame(t(sdata@assays[[assay]]@counts[genes,]))
  tmp$x = sdata@images[[sample]]@coordinates$imagecol
  tmp$y = -sdata@images[[sample]]@coordinates$imagerow
  
  cc = scale_color_gradientn(colors = c("gray","yellow","red","black"))
  small.leg <- theme(legend.text = element_text(size=6), legend.key.width = unit(0.1,"cm"))
  pl = list()
  for (g in genes){
    g2 = sym(g)
    pl[[g]] = ggplot(tmp, aes(x=x,y=y,color= !! g2)) + geom_point()  + theme_classic() + cc + ggtitle(g) + NoAxes() + small.leg
  }
  if (is.null(nPlot)){ nPlot = length(genes)}
  if (nPlot > ncol*nrow){
    print("Cannot fit all figures into a single plot")
    nPlot = ncol*nrow()
  }
  nBin = ceiling(length(pl)/nPlot)
  for (i in 1:nBin){
    x = (i*nPlot+1-nPlot):min(length(pl),i*nPlot)
    grid.arrange(grobs=pl[x], ncol=ncol, nrow=nrow)
  }
}

```

```{r}
plot.prop = function(sdata, assay="DWLS"){
  cell.propDW = rowSums(sdata@assays[[assay]]@counts)
  cell.propDW = cell.propDW/sum(cell.propDW)
  par(mar=c(8,3,2,1))
  barplot(sort(cell.propDW, decreasing = T), las=2, main = sprintf("Proportion of celltypes %s",assay))
  cell.propDW = cell.propDW[order(names(cell.propDW))]
  return(cell.propDW)
}
```


# DWLS

Load DWLS results, is already normalized so scores from each row sums to 1.

```{r}

dfile = file.path(input_dir,"giotto_dwls",sample,"dwls_fc0.5_pval0.01.csv")
D = read.csv(dfile, row.names = 1)
rownames(D) = D$cell_ID
D = D[,-1]

# OBS! Rownames are missing the "_11" extensions
rownames(D) = paste0(rownames(D), "_11")

# add as an assay object.
st.data[['DWLS']] <- CreateAssayObject(counts = t(D))

celltypes = colnames(D)

celltypes = sort(celltypes)
```


Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "DWLS")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "DWLS")

```

Check what are the most abundant celltypes

```{r}
cell.prop = list()
cell.prop$DWLS = plot.prop(st.data, assay = "DWLS")
```

# Tangram

## Tangram fc0.5 pval0.01

First, tangram with same gene list as for DWLS

```{r}
dfile = file.path(input_dir,"tangram",sample,"tangram_fc0.5_pval0.01_cpm.csv")
#dfile = file.path(input_dir,"tangram",sample,"tangram_fc0.5_pval0.01_lognorm.csv")

D = read.csv(dfile, row.names = 1)

range(rowSums(D))
# total values per spot adds up to 5-6. 

# normalize per spot?
# D = sweep(D, 1, rowSums(D), '/') 

# add in "_11"
rownames(D) = paste0(rownames(D), "_11")

# add as an assay object.
st.data[['Tangram_full']] <- CreateAssayObject(counts = t(D))

```

Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "Tangram_full")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "Tangram_full")

```

Check what are the most abundant celltypes

```{r}
cell.prop$Tangram_full = plot.prop(st.data, assay = "Tangram_full")
```

## Tangram with lognorm

Same gene list but running tangram after lognorm of both ST and SC data


```{r}
dfile = file.path(input_dir,"tangram",sample,"tangram_fc0.5_pval0.01_lognorm.csv")

D = read.csv(dfile, row.names = 1)

range(rowSums(D))
# total values per spot adds up to 5-6. 

# normalize per spot?
# D = sweep(D, 1, rowSums(D), '/') 

# add in "_11"
rownames(D) = paste0(rownames(D), "_11")

# remove _ln from colnames
colnames(D) = sub("_ln","",colnames(D))

# add as an assay object.
st.data[['Tangram_ln']] <- CreateAssayObject(counts = t(D))

```

Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "Tangram_ln")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "Tangram_ln")

```

Check what are the most abundant celltypes

```{r}
cell.prop$Tangram_ln = plot.prop(st.data, assay = "Tangram_ln")
```

## Tangram with top100 genes


```{r}
dfile = file.path(input_dir,"tangram",sample,"tangram_top100_cpm.csv")

D = read.csv(dfile, row.names = 1)

range(rowSums(D))
# total values per spot adds up to 5-6. 

# normalize per spot?
# D = sweep(D, 1, rowSums(D), '/') 

# add in "_11"
rownames(D) = paste0(rownames(D), "_11")

# add as an assay object.
st.data[['Tangram_100']] <- CreateAssayObject(counts = t(D))

```

Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "Tangram_100")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "Tangram_100")

```

Check what are the most abundant celltypes

```{r}
cell.prop$Tangram_100 = plot.prop(st.data, assay = "Tangram_100")
```

# RCTD

```{r}
dfile = file.path(input_dir,"rctd",sample,"RCTD_res.csv")

D = read.csv(dfile, row.names = 1)

range(rowSums(D))
# total values per spot adds up to 5-6. 

# normalize per spot?
# D = sweep(D, 1, rowSums(D), '/') 

# add as an assay object.
st.data[['RCTD']] <- CreateAssayObject(counts = t(D))

```

Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "RCTD")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "RCTD")

```

Check what are the most abundant celltypes

```{r}
cell.prop$RCTD = plot.prop(st.data, assay = "RCTD")
```


# SCDC


```{r}
dfile = file.path(input_dir,"scdc",sample,"scdc_prop.est.mvw.csv")

D = read.csv(dfile, row.names = 1)

# add as an assay object.
st.data[['SCDC']] <- CreateAssayObject(counts = t(D))

```

Plot onto umap

```{r, fig.width=12, fig.height=10}
plot.gene.umap(st.data, celltypes, assay = "SCDC")
```

Plot spatial without image in background.

```{r, fig.width=12, fig.height=10}
plot.gene.st(st.data, celltypes, sample, assay = "SCDC")

```

Check what are the most abundant celltypes

```{r}
cell.prop$SCDC = plot.prop(st.data, assay = "SCDC")
```

# Compare

## Proportions

Look at celltype abundances across methods

```{r}
# remove unass

tot.prop = data.frame(Reduce(cbind,cell.prop))
colnames(tot.prop) = names(cell.prop)
rownames(tot.prop) = celltypes

tot.prop$celltype = celltypes

l = reshape2::melt(tot.prop, id.vars = "celltype")

p5 = ggplot(l, aes(x=variable,y=value, fill=celltype)) + geom_bar(position = "fill",stat = "identity") + RotatedAxis() 

# need better color scale
# scale_fill_manual(values = sc.colors)

```

```{r}
# define colors for the clusters.

cols = rep(NA,27)
# greens for basal
cols[2:5]=colorRampPalette(c("green", "darkgreen"))(4)
# pink/purple for fibs
cols[7:10]=colorRampPalette(c("pink", "purple3"))(4)
# blu spinous
cols[23:25]=colorRampPalette(c("lightblue", "darkblue"))(3)
# cyans for Granular
cols[11:12]=c("cyan","cyan3")
# immune cells in yellow to orange
cols[c(1,6,15,16,18:20,26)] =colorRampPalette(c("yellow", "red"))(8)
# rest in grays
cols[c(13,14,17,21,22,27)] = colorRampPalette(c("grey82", "gray30"))(6)

names(cols)=celltypes

p5 + scale_fill_manual(values = cols)


```

Tangram gives about equal proportion of all celltypes, not really useful.

DWLS and RCTD are fairly similar, but much more Macrophages with DWLS. 

## Celltypes per spot

What is the abundance of the top celltype. OBS! Would require normalization per spot of the scores.

```{r}
methods = names(cell.prop)

par(mfrow = c(3,3))
for (m in methods){
  d = st.data@assays[[m]]@counts
  d = sweep(d, 2, colSums(d), '/')
  top = apply(d,2,max)
  hist(top, main=m, n=100)
}
```

For all of them, very few spots with one abundant celltype.

Count number of celltypes per spot, only count ones with proportion > 3%.


```{r}
par(mfrow = c(3,3))
for (m in methods){
  d = st.data@assays[[m]]@counts
  d = sweep(d, 2, colSums(d), '/')
  nD = colSums(d>0.03)
  hist(nD, main=m, n=100)
}
```

Still, with tangram, all spots have no celltype over 3% , afew spots with RCTD and DWLS have more than 1 celltype over 3%

# Clustering with celltype proportions

Use the RCTD matrix to recluster the spots

```{r, fig.height=10}
st.data@active.assay= "RCTD"
st.data$integrated_clust = st.data$seurat_clusters

st.data = ScaleData(st.data)
st.data = RunPCA(st.data, features = celltypes, reduction.name = "pcaR", verbose = F, assay = "RCTD")
st.data = RunUMAP(st.data, reduction = "pcaR", reduction.name = "umapR", dims = 1:10, verbose = F, assay = "RCTD")
st.data = FindNeighbors(st.data, reduction = "pcaR",  dims = 1:10, verbose = F)
st.data = FindClusters(st.data, resolution = 0.9, verbose = F)

p = DimPlot(st.data, reduction = "umapR", group.by = "integrated_clust") + NoAxes()
p2 = DimPlot(st.data, label = T) + NoAxes()
p3 = SpatialDimPlot(st.data, images = sample)
p4 = SpatialDimPlot(st.data, group.by = "integrated_clust", images = sample)
grid.arrange(p,p2,p3,p4, ncol = 2)
```


### Session info

```{r}
sessionInfo()
```
