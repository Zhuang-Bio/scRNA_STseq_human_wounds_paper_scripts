---
title: "Tangram with mock cell numbers"
author: "Åsa Björklund"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    fig_caption: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, result='hold',fig.width=12,fig.height = 10,tidy=TRUE)
knitr::opts_knit$set(progress=TRUE,verbose=TRUE)
```

Tangram was run with number of cells simply based on number of features ranging from 0 to 40 cells.

Only for Donor1_Skin

## Load

### Load packages

```{r packages}
suppressPackageStartupMessages(require(Matrix))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(gridExtra))
source("../../functions/overlap_phyper_v2.R")
```

```{r}
cl.colors = c("#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4",
    "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8",
    "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9", "#000000")
names(cl.colors) = as.character(0:20)


```


Load ST data

```{r, }
st.data = readRDS(file = "../../../spatial/results/all/all_harmony.rds")

st.data = st.data[,st.data$Sample_name == "Donor1_Skin"]

```

## Load tangram results

```{r}
input_dir = "../../../deconv/results/tangram/Donor1_Skin/"

pred = read.csv(file.path(input_dir,"mock_segment_scores.csv"), row.names = 1)
counts = read.csv(file.path(input_dir,"mock_segment_counts.csv"), row.names = 1)

nCell = counts$cell_n

counts = counts[,5:ncol(counts)]

rsum = rowSums(counts)

plot(nCell, rsum)


```



```{r}
cell.prop = colSums(counts)

barplot(sort(cell.prop), las = 2)
```

OBS! Basal IV was not removed before running tangram, remove first

```{r}
counts = counts[,colnames(counts) != "Basal.IV"]

counts = counts[,order(colnames(counts))]
```


Even if the number of cells goes up to 40 the sum of the counts is up to 60 and some spots with up to 5 nCell, still has no predicted celltype. 

```{r}
rownames(counts) = paste0(rownames(counts), "_1")

st.data[['Tangram']] <- CreateAssayObject(counts = t(counts))

st.data$pred_nCelltypes = nCell

FeatureScatter(st.data, "nFeature_Spatial", "nCount_Tangram")
FeatureScatter(st.data, "nFeature_Spatial", "pred_nCelltypes")
```









Make nwe matrix with presense absence of celltype...

```{r}
celltypes = rownames(st.data@assays$Tangram)

sample = "Donor1_Skin"
pl = SpatialFeaturePlot(st.data, features = celltypes, combine = F, images = sample)

grid.arrange(grobs = pl, ncol=4)
```

## Redo graphs

New graphs based on the cutoffs.

```{r}
co.occ = apply(counts>0,2,which)

o = overlap_phyper2(co.occ, co.occ, title = "All", remove.diag = T, plot = F, bg = ncol(st.data))


```


As graph





```{r}
#celltypes = rownames(prop)
celltypes = sort(celltypes)

cols = rep(NA, 26)
# greens for basal
cols[2:4] = colorRampPalette(c("green", "darkgreen"))(3)
# pink/purple for fibs
cols[6:9] = colorRampPalette(c("pink", "purple3"))(4)
# blu spinous
cols[22:24] = colorRampPalette(c("lightblue", "darkblue"))(3)
# cyans for Granular
cols[10:11] = c("cyan", "cyan3")
# immune cells in yellow to orange
cols[c(1, 5, 14, 15, 17:19, 25)] = colorRampPalette(c("yellow", "red"))(8)
# rest in grays
cols[c(12, 13, 16, 20, 21, 26)] = colorRampPalette(c("grey82", "gray30"))(6)

names(cols) = celltypes


n = rep(1,length(cols))
names(n) = celltypes
barplot(n,col = cols, las = 2)

```


```{r}
library(igraph)
make.igraph = function(ptest, cutoff = 0.1, title = "Celltype co-occurence") {
    pvals = ptest$P[-ncol(ptest$P), -nrow(ptest$P)]

    pseudo = min(pvals[pvals > 0 & !is.na(pvals)])
    pvals[pvals == 0] = pseudo

    # filer all edgens with pval > cutoff
    pvals[pvals > cutoff] = 1

    # convert to weights
    w = -log10(pvals)
    g = graph_from_adjacency_matrix(w, mode = "undirected", weighted = T, diag = F)
    set.seed(13)
    g.layout <- layout_with_graphopt(g)
    # g.layout<-layout_with_lgl(g, maxiter = 500)
    V(g)$color = cols
    # scale point size by proportions
    nC = ptest$M[-ncol(ptest$M), ncol(ptest$M)]

    # plot.igraph(g,layout=g.layout, vertex.label.color='black',
    # edge.width=E(g)$weight/10, main = title)
    plot.igraph(g, layout = g.layout, vertex.label.color = "black", edge.width = E(g)$weight/10,
        vertex.size = nC/sum(nC) * 200, vertex.label.dist = 2, main = title)

    return(list(g = g, layout = g.layout))
}

g = make.igraph(o, title = "All", cutoff = 1e-5)
```





### Session info

```{r}
sessionInfo()
```
