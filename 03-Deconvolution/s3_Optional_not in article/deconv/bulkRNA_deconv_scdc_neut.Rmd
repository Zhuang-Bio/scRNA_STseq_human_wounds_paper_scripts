---
title: "BulkRNA deconvolution with neutrophils"
author: "Åsa Björklund"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    fig_caption: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, result='hold',fig.width=12,tidy=TRUE)
knitr::opts_knit$set(progress=TRUE,verbose=TRUE)
```

Take all samples from both ST and SC analysis and calculate a pseudobulk dataset.

For the SC data, include the neutrophils. OBS! Need to recalculate DEGs for the neutrophils to include in the gene list for deconv.

Compare to the FPKM matrix of the bulkRNAseq data. Should be more similar to the UMI data than the raw count matrix from bulkRNAseq. But also run deconvolution with the raw counts.
Same as bulkRNA_deconv_scdc.Rmd but using the full FPKM/Count matrices.

Run deconvolution with SCDC for all of them.


# Load

### Load packages

```{r packages}

suppressPackageStartupMessages(require(Matrix))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(gridExtra))
suppressPackageStartupMessages(require(magrittr))
suppressPackageStartupMessages(require(patchwork))
suppressPackageStartupMessages(require(pheatmap))
```


# Load

```{r}
cl.colors = c("#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4",
    "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8",
    "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9", "#000000",
    "#add8e6", "#ffa07a", "#228b22", "#dcdcdc")
names(cl.colors) = as.character(0:24)

cc = scale_color_gradientn(colors = c("grey", "yellow", "red", "black"))
small.leg <- theme(legend.text = element_text(size = 6), legend.key.width = unit(0.1,
    "cm"))

outdir = "../../deconv/results/bulk_scdc"
dir.create(outdir, showWarnings = F)
```



## Load SC data


```{r}
indir = "../../scRNAseq/results/zhuang_analysis/oct12/"
savefile = file.path(indir, "s1_cleanSeurat_harmony_allSamples_clusters.rds")
sc.data = readRDS(file = savefile)


# add new celltype annotation
anno <- readxl::read_xlsx(file.path(indir, "s5_cell_types_for_each_cluster_manually_updated.xlsx"),
    sheet = 1)
ct = plyr::mapvalues(x = Idents(sc.data), from = c(anno$Cluster), to = c(anno$CellType))
sc.data$Celltype = factor(ct, levels = sort(levels(ct)))

subtype = plyr::mapvalues(x = Idents(sc.data), from = c(anno$Cluster), to = c(anno$Detailed_info))
sc.data$Subtype = factor(subtype, levels = sort(levels(subtype)))

type = plyr::mapvalues(x = Idents(sc.data), from = c(anno$Cluster), to = c(anno$MainCellTypes))
sc.data$MainCelltype = factor(type, levels = sort(levels(type)))

table(sc.data$orig.ident)

DimPlot(sc.data, group.by = "Celltype",label=T)+NoAxes()
```

Remove BAsal-IV and SCT data

```{r}
sc.data@active.assay = "RNA"
sc.data = DietSeurat(sc.data, assays = "RNA")

sc.data = sc.data[,sc.data$Celltype != "Basal-IV"]
```

Add annotations in same format as for the ST data using same donor IDs.

```{r}
# Donor Sample_name
# PHW26,27,28 to Donor5,Donor4,Donor3
id2donor = c("Donor5", "Donor4", "Donor3")
names(id2donor) = c("PWH26","PWH27","PWH28")
sc.data$Donor = id2donor[sc.data$Patient]
table(sc.data$Donor)

sc.data$Sample_name = paste(sc.data$Donor, sc.data$Condition, sep= "_")
table(sc.data$Sample_name)
```

### Fetch full expression

OBS! The SC data has been filtered to remove cells that are expressed in 10 cells or less, so the gene numbers are different to the ST data, but also the naming for non-unique genes as the data was loaded with min.cells = 3.

```{r}
indir = "../../scRNAseq/rawdata/"

# obs folder names are not NGI_ID, but User_ID without '_'
alldata = list()
for (sample in dir(indir)) {
    print(sample)
    hfile = file.path(indir, sample, "filtered_feature_bc_matrix.h5")
    if (!file.exists(hfile)) {
        print(sprintf("No file %s", hfile))
        (next)()
    }
    alldata[[sample]] = CreateSeuratObject(counts = Read10X_h5(hfile), project = sample)
}

tmp  = merge(alldata[[1]], alldata[2:length(alldata)], add.cell.ids = names(alldata))

m = match(colnames(sc.data), colnames(tmp))
tmp = tmp[,m]

tmp@meta.data = sc.data@meta.data
tmp@reductions$umap = sc.data@reductions$umap
sc.data = tmp

rm(alldata, tmp)
g = gc(verbose = F)

```

## Add in neutrophil data

```{r}
ndata = readRDS(file = "../../scRNAseq/results/neutrophil_selections.rds")
table(ndata$Condition)

ndata$Celltype = "Neutrophil"
ndata$MainCelltype = "Neutrophil"

genes = intersect(rownames(ndata), rownames(sc.data))
ndata = ndata[genes,]
sc.data = sc.data[genes,]

sc.data = merge(sc.data,ndata)

table(sc.data$Celltype)
rm(ndata)
gc()
```





###  Calculate pseudocounts 

Calculate pseudobulk per sample as sum of UMI counts.

```{r}
samples.sc = unique(sc.data$Sample_name)

all.counts = list()

for (sample in samples.sc){

  tmp = sc.data@assays$RNA@counts[,sc.data$Sample_name == sample]
  all.counts[[sample]] = rowSums(tmp)
}


sc.counts = Reduce(cbind,all.counts)
colnames(sc.counts) = paste("SC",samples.sc,sep="_")


```

### Subsample celltypes for deconv

Subsample 100 cells per cluster and condition.

```{r}
#sc.data$Celltype = droplevels(sc.data$Celltype)

sc.ct.prop = table(sc.data$Sample_name,sc.data$Celltype)

sc.data = SetIdent(sc.data, value = "Celltype")

keep.cells = c()
for (cond in unique(sc.data$Condition)){
   cells = WhichCells(sc.data[, sc.data$Condition == cond], downsample = 100)
   keep.cells = cbind(keep.cells, cells)
}

sc.data = sc.data[,keep.cells]
table(sc.data$Celltype)

sc.data = NormalizeData(sc.data)

```

Save file:

```{r}
saveRDS(sc.data, file = file.path(outdir, "scRNAseq_subsampled_neut.rds"))
```



## Rerun DEG detection

```{r}
mfile = file.path(outdir,"celltype_markers_w_neut.csv")
if (file.exists(mfile)){
  markers = read.csv(mfile)
}else{
  markers <- FindAllMarkers(
    sc.data,
    only.pos = TRUE,
    min.pct = 0.25,  
    logfc.threshold = 0.25,
    test.use = "MAST")
  write.csv(markers, file = mfile)
}

```


Filter for only PC genes and also DEGs based on pvalue FC and pct.diff

```{r}
gene.info = read.csv("../../spatial/meta/genes_parsed.csv")
pc.genes = gene.info$gene_name[gene.info$gene_type == "protein_coding"]

markers.pc = markers[markers$gene %in% pc.genes,]

#markers = markers[markers$gene %in% common.genes,]

markers.pc$pct.diff <- markers.pc$pct.1 - markers.pc$pct.2
markers.pc$log.pct.diff <- log2((markers.pc$pct.1 * 99 + 1)/(markers.pc$pct.2 * 99 +
    1))
markers.pc %>%
    group_by(cluster) %>%
    top_n(-100, p_val) %>%
    top_n(50, pct.diff) %>%
    top_n(20, log.pct.diff) -> top20
de.genes <- unique(as.character(top20$gene))
print(length(de.genes))

source("../functions/overlap_phyper_v2.R")
l = split(top20$gene,top20$cluster)
l = l[order(names(l))]
o = overlap_phyper2(l,l)
```


## ST data

```{r}
st.data = readRDS(file = "../../spatial/results/all/all_filtered.rds")
st.data@active.assay = "Spatial"

# remove other assays than RNA
st.data = DietSeurat(st.data, assays = "Spatial", dimreducs = c("pca","umap","harmony"))
g = gc(verbose = F)

```

### Calculate pseudocounts 

Calculate pseudobulk per sample as sum of UMI counts.

```{r}
samples.st = unique(st.data$Sample_name)

all.counts = list()

for (sample in samples.st){

  tmp = st.data@assays$Spatial@counts[,st.data$Sample_name == sample]
  all.counts[[sample]] = rowSums(tmp)
}

st.counts = Reduce(cbind,all.counts)
colnames(st.counts) = paste("ST",samples.st,sep="_")

#rm(st.data)
#g = gc(verbose = F)

```

## Bulk data

```{r}
# read from excel file, 
# first is counts, second is fpkms
# counts has columns:
# Geneid	GeneSymbol	Class	Chr	Start	End	Strand	Length
# Fpkm has:
# ID	GeneSymbol	Class

bulk = readxl::read_xlsx("../../scRNAseq/rawdata/SS2_bulk/bulk/wound healing-whole biopsy bulkseq raw expression data.xlsx", sheet = 2)
ginfo = bulk[,1:3]

bulk = as.matrix(bulk[,4:ncol(bulk)])
rownames(bulk) = make.unique(ginfo$GeneSymbol)
dim(bulk)

bulk.counts = readxl::read_xlsx("../../scRNAseq/rawdata/SS2_bulk/bulk/wound healing-whole biopsy bulkseq raw expression data.xlsx", sheet = 1)

ginfo = bulk.counts[,1:8]
bulk.counts = as.matrix(bulk.counts[,9:ncol(bulk.counts)])
rownames(bulk.counts) = make.unique(ginfo$GeneSymbol)


dim(bulk.counts)
```


Have 60603 genes in genecode, but only 12069 genes in the FPKM file. Only PC genes?


```{r}
m = match(rownames(st.data), rownames(sc.data))

m = match(rownames(st.data), rownames(bulk))

nrow(st.data)
nrow(bulk)
common.genes = intersect(rownames(st.data), intersect(rownames(bulk), rownames(sc.data)))
length(common.genes)
```

Use only the genes that are in all 3 datasets.

```{r}
sc.counts = sc.counts[common.genes,]
st.counts = st.counts[common.genes,]
bulk = bulk[common.genes,]
bulk.counts = bulk.counts[common.genes,]
```

Create similar metadata

```{r}

bulk = bulk[,order(colnames(bulk))]
bulk.counts = bulk.counts[,order(colnames(bulk.counts))]
cn = colnames(bulk)


s = strsplit(cn,"_")
s2 = unlist(lapply(s[1:10], function(x) x[1]))
s2.cond = gsub("[0-9]+", "", s2)
s3 = unlist(lapply(s[11:20], function(x) paste(x[c(1,2)], collapse = "_")))
s3.cond = unlist(lapply(s[11:20], function(x) x[1]))

meta.bulk = data.frame(row.names = cn, Tech = "Bulk_FPKM", Donor= c(s2,s3), Condition = c(s2.cond,s3.cond))
meta.bulk.C = data.frame(row.names = colnames(bulk.counts), Tech = "Bulk_C", Donor= c(s2,s3), Condition = c(s2.cond,s3.cond))

```




## Merge all

Create seurat objects from each of the datasets and compare them.

```{r}

alldata = list()
meta.sc = data.frame(Reduce(rbind,strsplit(colnames(sc.counts),"_")), row.names = colnames(sc.counts))
colnames(meta.sc) = c("Tech","Donor","Condition")
alldata$SC = CreateSeuratObject(sc.counts,meta.data = meta.sc)

meta.st = data.frame(Reduce(rbind,strsplit(colnames(st.counts),"_")), row.names = colnames(st.counts))
colnames(meta.st) = c("Tech","Donor","Condition")
alldata$ST = CreateSeuratObject(st.counts,meta.data = meta.st)

alldata$Bulk = CreateSeuratObject(bulk, meta.data = meta.bulk)
alldata$BulkC = CreateSeuratObject(bulk.counts, meta.data = meta.bulk.C)

all = merge(alldata[[1]], alldata[2:length(alldata)],merge.data = T)

all = NormalizeData(all)
```


Save file:

```{r}
saveRDS(all, file = "../../deconv/inputs/bulks/bulk_sobject_neut.rds")
```


# Correlation heatmap

```{r, fig.height=12, fig.width=12}

C = cor(as.matrix(all@assays$RNA@data))

meta = all@meta.data[,c("Tech","Condition","Donor")]

pheatmap(C, annotation = meta[,c(1,2)], clustering_method = "ward.D2")

```


Plot only Bulk vs ST correlation as boxplots for FPKM values.

```{r, fig.height=10}
tmp = C[grepl("FPKM", rownames(C)),]
tmp = tmp[,grepl("ST", colnames(tmp))]

tmp = data.frame(tmp)
tmp$bulk.type = meta[rownames(tmp),"Condition"]

l = reshape2::melt(tmp, id.vars = "bulk.type")
l$st.type = meta[l$variable,"Condition"]

ggplot(l, aes(x=st.type,y=value)) + geom_boxplot() + facet_wrap(~bulk.type)  + ggtitle("Corr Bulk vs ST")

```

Skin has highest correl to skin, wound1 to wound1, VU to wound30, but bulk wound7 has higher correl to ST wound30.


Same for bulk counts.

```{r}
tmp = C[meta$Tech == "Bulk_C",]
tmp = tmp[,grepl("ST", colnames(tmp))]

tmp = data.frame(tmp)
tmp$bulk.type = meta[rownames(tmp),"Condition"]

l = reshape2::melt(tmp, id.vars = "bulk.type")
l$st.type = meta[l$variable,"Condition"]

ggplot(l, aes(x=st.type,y=value)) + geom_boxplot() + facet_wrap(~bulk.type)  + ggtitle("Corr Bulk-Counts vs ST")
```

Clearly lower correlation values but here Wound7 has highest correl to Wound7.

# PCA

Run PCA with top 1K genes.

```{r, fig.height=10}

all = FindVariableFeatures(all, verbose = F, nfeatures = 3000)
all = ScaleData(all, verbose = F)
# all = RunPCA(all, verbose = F)
# does not work to run irlba
# Error in irlba(A = t(x = object), nv = npcs, ...) : max(nu, nv) must be strictly less than min(nrow(A), ncol(A))

pc = prcomp(t(all@assays$RNA@scale.data))
pc = data.frame(cbind(pc$x,meta))

p1 = ggplot(pc, aes(x=PC1, y=PC2, color=Condition, shape=Tech)) + geom_point(size=6) + theme_classic()
p2 = ggplot(pc, aes(x=PC3, y=PC4, color=Condition, shape=Tech)) + geom_point(size=6) + theme_classic()
p3 = ggplot(pc, aes(x=PC5, y=PC6, color=Condition, shape=Tech)) + geom_point(size=6) + theme_classic()
p4 = ggplot(pc, aes(x=PC7, y=PC8, color=Condition, shape=Tech)) + geom_point(size=6) + theme_classic()

grid.arrange(p1,p2,p3,p4, ncol=2)

```

Clearly PC1,2 separate by tech, but PC3,4 separates Wound1 and partly Skin samples from all techs. PC8 separates Wound7.

# Deconvolution

```{r}
library(SCDC)
library(Matrix)
library(Biobase)


```




Load gene list that was used for Stereoscope (fc>0.5, pval<0.01)

```{r}


# take only ones that are included in the common genes
d.genes = intersect(de.genes, common.genes)

```


Create SC expression set:

```{r}
scMeta = sc.data@meta.data[,c("Sample_name","Celltype","Donor")]
sc.eset = ExpressionSet(assayData=as.matrix(sc.data@assays$RNA@counts[d.genes,]),
                         phenoData =  AnnotatedDataFrame(scMeta))
```

Create ST/Bulk expression set:

```{r}
stMeta = all@meta.data[,c("Tech","Donor","Condition")]

bulk.eset = ExpressionSet(assayData = as.matrix(all@assays$RNA@counts[d.genes,]),
                          phenoData = AnnotatedDataFrame(stMeta))
```

```{r}
deconvolution_crc <- SCDC_prop(bulk.eset = bulk.eset,
                       sc.eset = sc.eset,
                       ct.varname = "Celltype",
                       ct.sub = as.character(unique(scMeta$Celltype)))

write.csv(deconvolution_crc$prop.est.mvw, quote = F, file=file.path(outdir, "scdc_prop.est.mvw_neut.csv"))

saveRDS(deconvolution_crc, file=file.path(outdir, "scdc_prop_obj_full_neut.rds"))

```



### Results

```{r}
# remove Basal-IV from df
anno = anno[anno$CellType != "Basal-IV",]
# add Neutrophil info.
anno = rbind(anno,c(27,"Neutrophil","Neutrophil","","Neutrophil"))

anno = anno[order(anno$MainCellTypes,anno$CellType),]

anno$Color = NA
anno[grepl("Basal", anno$CellType),"Color"] = colorRampPalette(c("green", "darkgreen"))(3)
anno[grepl("Spinous", anno$CellType),"Color"] = colorRampPalette(c("lightblue", "darkblue"))(3)
anno[grepl("Granular", anno$CellType),"Color"] = c("cyan", "cyan3")
anno[grepl("FB", anno$CellType),"Color"] = colorRampPalette(c("pink", "purple3"))(4)
anno[anno$CellType %in% c("LC","LE","PC-vSMC","MEL","Schwann","VE"),"Color"] = colorRampPalette(c("grey82", "gray30"))(6)
anno[anno$CellType == "Neutrophil","Color"] = "magenta"
anno[is.na(anno$Color),"Color"] = colorRampPalette(c("yellow", "red"))(8)

ct.cols = anno$Color
names(ct.cols) = anno$CellType
```



```{r, fig.width=12, fig.height=8}
pred = data.frame(deconvolution_crc$prop.est.mvw, check.names = F)
pred = pred[,anno$CellType] # reorder
# reorder samples as well
pred = pred[order(meta$Tech,meta$Condition),]

pred$Sample = factor(rownames(pred), levels = rownames(pred))
l = reshape2::melt(pred, id.vars = "Sample")

p5 = ggplot(l, aes(x = Sample, y = value, fill = variable)) + geom_bar(position = "fill",
    stat = "identity") + RotatedAxis() + scale_fill_manual(values = ct.cols)
print(p5)

```

* A very large proportion of the bulk Wound1 and Wound7 samples are now Neutrophil.
* For ST high level of neutrophils in Wound1 but only in one sample from Wound7

### Compare to true abundances for SC data

Just to check how well the method works, the SC pseudobulk should have the correct proportions.


```{r}

ct = as.data.frame.matrix(sc.ct.prop)
# reorder
ct = ct[,anno$CellType]
c.cond = unlist(lapply(strsplit(rownames(ct),"_"), function(x) x[2]))
ct = ct[order(c.cond),]
ct$Sample = factor(rownames(ct), levels = rownames(ct))
l = reshape2::melt(ct, id.vars = "Sample")



p1 = ggplot(l, aes(x = Sample, y = value, fill = variable)) + geom_bar(position = "fill",
    stat = "identity") + RotatedAxis() + scale_fill_manual(values = ct.cols) + ggtitle("True proportions") + small.leg

pr = pred[grepl("SC", rownames(pred)),]
l = reshape2::melt(pr, id.vars = "Sample")

p2 = ggplot(l, aes(x = Sample, y = value, fill = variable)) + geom_bar(position = "fill",
    stat = "identity") + RotatedAxis() + scale_fill_manual(values = ct.cols) + ggtitle("Predicted") + small.leg

p1 + p2

```




### Session info

```{r}
sessionInfo()
```
