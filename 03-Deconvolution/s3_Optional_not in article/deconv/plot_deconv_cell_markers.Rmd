---
title: "Plot deconv and cell markers"
author: "Åsa Björklund"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    fig_caption: true
    code_folding: hide
---

Plot together for each section, the deconv results and the top markers for that celltype.

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, result='hold',fig.width=12,tidy=TRUE)
knitr::opts_knit$set(progress=TRUE,verbose=TRUE)
```

## Load

### Load packages

```{r packages}
suppressPackageStartupMessages(require(reticulate))
use_python("/Users/asbj/miniconda3/envs/test_xu-landen_R/bin/python3")
suppressPackageStartupMessages(require(Matrix))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(gridExtra))
suppressPackageStartupMessages(require(magrittr))
suppressPackageStartupMessages(require(patchwork))
suppressPackageStartupMessages(require(harmony))
source("../functions/overlap_phyper_v2.R")
```


```{r}

cl.colors = c("#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4", 
    "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8", 
    "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9", "#000000", "#add8e6","#ffa07a", "#228b22", "#dcdcdc")
names(cl.colors) = as.character(0:24)

cc = scale_color_gradientn(colors = c("grey", "yellow", "red", "black"))
small.leg <- theme(legend.text = element_text(size = 6), legend.key.width = unit(0.1, 
    "cm"))
```


# Load data

Sc data:

```{r}
data.sc = readRDS("../../deconv/inputs/sc_data/s1_subsampled.rds")

```

```{r}
celltypes = sort(unique(data.sc$cl.annot))

cols = rep(NA, 27)
# greens for basal
cols[2:5] = colorRampPalette(c("green", "darkgreen"))(4)
# pink/purple for fibs
cols[7:10] = colorRampPalette(c("pink", "purple3"))(4)
# blu spinous
cols[23:25] = colorRampPalette(c("lightblue", "darkblue"))(3)
# cyans for Granular
cols[11:12] = c("cyan", "cyan3")
# immune cells in yellow to orange
cols[c(1, 6, 15, 16, 18:20, 26)] = colorRampPalette(c("yellow", "red"))(8)
# rest in grays
cols[c(13, 14, 17, 21, 22, 27)] = colorRampPalette(c("grey82", "gray30"))(6)

names(cols) = celltypes


DimPlot(data.sc, group.by = "cl.annot", label = T, cols = cols) + NoAxes()
```


ST data

```{r}
#outdir = "../../spatial/results/all/"
#data.st = readRDS( file = file.path(outdir,"all_harmony.rds"))
input_dir = "../../deconv/results/stereoscope50/"
data.st = readRDS( file = file.path(input_dir, "seurat_object.rds"))

DimPlot(data.st, cols = cl.colors, label = T, reduction = "umap", group.by = "integrated_clust") + NoAxes()
```


Markers

```{r}
zdir = "../../scRNAseq/results/zhuang_analysis/oct12"
markers = readxl::read_xlsx(file.path(zdir, "s2_MarkerGenes_SingleR_Annotation_manually.xlsx"))
markers = markers[markers$p_val_adj < 0.01, ]

cl2markers = split(markers$gene, markers$cluster)
cl2annot = celltypes
names( cl2annot) = data.sc$seurat_clusters[match(celltypes, data.sc$cl.annot)]
names(cl2markers) = cl2annot[names(cl2markers)] 
# reorder
cl2markers = cl2markers[celltypes]

o = overlap_phyper2(cl2markers, cl2markers)
```

Plot only 10 top markers per cluster

```{r}
top10 = lapply(cl2markers, function(x) x[1:10])

o = overlap_phyper2(top10, top10, bg = length(unique(markers$gene)))
```


```{r, fig.height=10}
data1@active.ident = data1$cl.annot

#plot dotplot for 9 celltypes at a time
top = unique(unlist(top10[19:27]))
DotPlot(data1, features = top, assay = "RNA") + RotatedAxis()
top = unique(unlist(top10[10:18]))
DotPlot(data1, features = top, assay = "RNA") + RotatedAxis()
top = unique(unlist(top10[1:9]))
DotPlot(data1, features = top, assay = "RNA") + RotatedAxis()


```


* Mono-Mac and Mono-DC no clear distinction - also DC & LC very similar.
* 3 Spinous clusters very similar
* Fib clusters very similar, mainly FB-I has distinct signal. 
* Basal-IV no clear signal, overalps with other Basal and Granular-I

# Plot

```{r}
plotdir = file.path(input_dir, "expression_plots")
dir.create(plotdir, showWarnings = F)

force = FALSE
for (ct in setdiff(celltypes, "Basal-IV")){
  print(ct)
  plotfile = paste0(plotdir,"/deconv_and_markers_",ct,".pdf")
  if (file.exists(plotfile) & !force){ next }
  pdf(plotfile, height = 10, width = 14)
  genes = cl2markers[[ct]][1:10]
  p1 = DotPlot(data.sc, features = genes, group.by = "cl.annot", dot.scale = 4) + RotatedAxis()  + coord_flip() + NoLegend() + theme(text = element_text(size=4), axis.text.x = element_text(size=6), axis.text.y = element_text(size=6)) 
 for (section in unique(data.st$Sample_name)){
      data.st@active.assay = "Stereoscope"
      p2 = SpatialFeaturePlot(data.st[,data.st$Sample_name == section], features = ct, images = section, alpha = c(0.2,1))
      data.st@active.assay = "Spatial"
      p3 = SpatialFeaturePlot(data.st[,data.st$Sample_name == section], features = genes, images = section, alpha = c(0.2,1), combine = F)
      grid.arrange(grobs = c(list(p1),list(p2),p3), ncol = 4, top=section)
  } 
  dev.off()
}


```


### Session info

```{r}
sessionInfo()
```
