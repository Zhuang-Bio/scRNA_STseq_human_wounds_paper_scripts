---
title: "Diabetic foot ulcers"
author: "Zhuang Liu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true #add a table of contents (TOC)
    toc_depth: 3 #headers' level in the toc
    toc_float: true #toc visible even when scrolled
    theme: lumen
    highlight: tango
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center', fig.width=12, fig.height = 6, warning=FALSE, message=FALSE)
```

Download the data from Theocharidis et al. paper (GSE165816) https://www.nature.com/articles/s41467-021-27801-8 

```{r warning=FALSE, message=FALSE}
library(Seurat)
library(SeuratObject)
library(SeuratDisk)
library(tidyverse)
library(patchwork)
library(sctransform)
library(harmony)
```


# 1. load the data
# Quality control
```{r eval=TRUE}
inteData <- readRDS("step1_diabetic_foot_ulcer_skin_integrated_harmony.rds")
FeaturePlot(inteData, features=c('KRT17', 'KRT6B', 'KRT6A', 'S100A2', 'KRT16'))
DimPlot(inteData, group.by = "SCT_snn_res.1", label = T)
# re-annotate the cell clusters
anno.cl <- list()
anno.cl$HE_Fibro = c(12) #MMP3, MMP1, CHI3L2, CHI3L1, TNFAIP6
anno.cl$FB_I_III_DFU = c(2,8,25) #ASPN, POSTN, WISP2, IGFBP6, COMP, APCDD1, PI16, ELN
anno.cl$FB_II_DFU = c(1,18) #APOD, CXCL14, C3, APOE, C2orf40
anno.cl$NKT_Lympho = c(5) #CD69, IL32, CD52, IL7R, PTPRC, NKG7
anno.cl$M1_Macro = c(11) #IL1B,EREG,
anno.cl$M2_Macro = c(9) #C1QA, C1QB, CD14, CD163
anno.cl$B_Lympho = c(23) #CD79A,MS4A1
anno.cl$VasEndo_art = c(16) #"IGFBP3","HEY1","SEMA3G"
anno.cl$VasEndo_ven = c(3) #RGCC
anno.cl$LymphEndo = c(21)
anno.cl$SMC2 = c(15) #MKI67, CENPF
anno.cl$SMC1 = c(0,4,7,13,24)
anno.cl$Melano_Schwann = c(19) #DCT, SOX10, SOX2
anno.cl$Mast = c(20) #TPSAB1, MS4A2
anno.cl$Sweat_Seba = c(17) #DCD, SCGB2A2, MUCL1, KRT19
anno.cl$OtherKera = c(14,22) #KRT17, KRT6B, KRT6A, S100A2, KRT16
anno.cl$BasalKera = c(10) #COL17A1, KRT5
anno.cl$DiffKera = c(6) #KRT1, KRT10, KRT16, KRT6A

trans = rep(names(anno.cl), times = unlist(lapply(anno.cl, length)))
names(trans) = unlist(anno.cl)
inteData$CellType = trans[as.character(inteData$SCT_snn_res.1)]
#DimPlot(inteData, group.by = "SCT_snn_res.1", cols = ct.cols, label = T)
DimPlot(inteData, group.by = "CellType", label = T) + ggtitle("") + NoLegend()

fac_levs <- c("BasalKera", "DiffKera", "OtherKera", "Sweat_Seba", 
              "HE_Fibro", "FB_I_III_DFU", "FB_II_DFU", "SMC1", "SMC2",
              "M1_Macro", "M2_Macro", "B_Lympho", "NKT_Lympho", 
              "LymphEndo", "VasEndo_art", "VasEndo_ven", "Melano_Schwann", "Mast")
ct.cols <- c("#d94701", "#fdae61", "#fd8d3c", "#35978f", 
             "#0570b0", "#33A02C", "#72BF5A", "#B2DF8A", "#3690c0", 
             "#f768a1", "#d4b9da", "#92c5de", "#d1e5f0",
             "#c0a700", "#1a9850", "#fb9a99", "#8d4720", "#fdbe85"
             )
names(ct.cols) <- fac_levs

inteData$CellType <- factor(inteData$CellType, levels = fac_levs)
DimPlot(inteData, group.by = "CellType", label = T, cols = ct.cols) + ggtitle("") + NoLegend()

DefaultAssay(inteData) <- "RNA"
inteData <- DietSeurat(inteData, assays = "RNA")

# extract the KC-related clusters
data_DFU <- subset(inteData, subset = CellType == "BasalKera" | CellType == "DiffKera" | CellType == "OtherKera")
data_DFU@meta.data <- droplevels(data_DFU@meta.data)
data_DFU$SCT_snn_res.0.8 <- NULL
data_DFU$SCT_snn_res.1 <- NULL
data_DFU$seurat_clusters <- NULL
data_DFU$SCT_snn_res.0.5 <- NULL
data_DFU$nCount_SCT <- NULL
data_DFU$nFeature_SCT <- NULL


# Rerun the clustering again
data_DFU <- NormalizeData(data_DFU)

all.data_DFU = SplitObject(data_DFU, split.by = "Donor1")
all.data_DFU <- lapply(X = all.data_DFU, FUN = SCTransform, method = "glmGamPoi", vars.to.regress = c("CC.Difference"))

# Run rPCA using SCTransform
options(future.globals.maxSize = 100000 * 1024^2) 
features <- SelectIntegrationFeatures(object.list = all.data_DFU, nfeatures = 3000)

all.data_DFU <- PrepSCTIntegration(object.list = all.data_DFU, anchor.features = features)
inteData <- merge(all.data_DFU[[1]], y = c(all.data_DFU[2:length(all.data_DFU)]), merge.data = TRUE)
VariableFeatures(inteData) <- features
rm(all.data_DFU);gc()

inteData <- RunPCA(inteData, npcs = 40, assay = "SCT")
ElbowPlot(inteData, ndims = 40)
inteData <- RunHarmony(inteData, assay.use = "SCT", reduction = "pca", dims.use = 1:30,
    group.by.vars = "Donor1", plot_convergence = TRUE)

inteData <- RunUMAP(inteData, dims = 1:30, assay = "SCT", reduction = "harmony")
DimPlot(inteData, group.by = "Donor1") + NoAxes()

inteData = FindNeighbors(inteData, dims = 1:30, reduction = "harmony", k.param = 30)
inteData = FindClusters(inteData, resolution = 0.5)
inteData = FindClusters(inteData, resolution = 1)
inteData = FindClusters(inteData, resolution = 0.8)
DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.1", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.0.5", label = T)
DimPlot(inteData, group.by = "CellType", label = T, cols = ct.cols) + ggtitle("") + NoLegend()

DefaultAssay(inteData) <- "RNA"
inteData <- NormalizeData(inteData)
FeaturePlot(inteData, features=c('KRT17', 'KRT6B', 'KRT6A', 'S100A2', 'KRT16', "MMP1", "MMP3","TNFRSF12A", "FGFBP1", "MKI67"), 
            cols = c("grey90", "red"))

DimPlot(inteData, group.by = "SCT_snn_res.1", label = T, split.by = "Condition")  

# load the predicted cell type annotations
anno_pred <- data.table::fread("step3_predictedCellType_AnnotatedCellType.txt")
anno_pred_f <- colnames(inteData) %>% as.data.frame() %>% setNames("barcode") %>% left_join(., anno_pred)
inteData$predictCellType <- anno_pred_f$predicted.id

DimPlot(inteData, group.by = "predictCellType", label = T) + ggtitle("")

inteData$fill <- ifelse(inteData$predictCellType %in% c("Bas_I", "Bas_mig", "Bas_prolif", "Spi_I", "Spi_II_a", "Spi_II_b", "Spi_III", "Spi_mig", "Gra_I"), "Yes", "No")

inteData_f <- subset(inteData, subset = fill == "Yes")
ct.cols.f <- ct.cols[1:9]
names(ct.cols.f) <- c("Bas_I", "Bas_mig", "Bas_prolif", "Spi_I", "Spi_II_a", "Spi_II_b", "Spi_III", "Spi_mig", "Gra_I")
ct.cols.f[c(2, 8)] <- c("#8d4720", "#f768a1")
DimPlot(inteData_f, group.by = "predictCellType", label = T, cols = ct.cols.f)
DimPlot(inteData_f, group.by = "predictCellType", label = T, cols = ct.cols.f, split.by = "Condition")

saveRDS(inteData, file = "step4_DFU_KC.rds")
```

# Wound KC data
```{r}
output_path <- "/Users/zhuliu/Desktop/scRNA_STseq/proj_10X_woundhealing/03_results/01-Seurat-PreAnalysis/02_Seurat_BatchCorrection/s2_Seurat_subKeratinocytes/"
kera_sub <- readRDS(paste0(output_path, "allNew_subcluster_keratins_220203.rds"))

# re-annotate the cell clusters
fac_levs <- c("Bas_I", "Bas_prolif", "Bas_mig", 
              "Spi_I", "Spi_II_a", "Spi_II_b",
              "Spi_III", "Spi_mig",
              "Gra_I")
current_cluster_ids <- c(1,5,6,3,0,4,8,2,7) # List of current cluster IDs
tmp <- plyr::mapvalues(x=kera_sub$SCT_snn_res.0.5, from=current_cluster_ids, to=fac_levs)

kera_sub$upCellTypes <- tmp
kera_sub$upCellTypes <- factor(kera_sub$upCellTypes, levels = fac_levs)

ct.cols <- c('#807dba','#9e9ac8','#ccebc5',
               '#fe9929','#fec44f','#fee391',
               '#fb8072','#b3de69','#fccde5')
names(ct.cols) <- fac_levs
DimPlot(kera_sub, group.by = "upCellTypes", cols = ct.cols)
kera_sub <- DietSeurat(kera_sub, assays = "RNA")
```


# 2. Integrate the DFU skin data with kera_sub data
```{r eval=TRUE}
# DFU skin integration using the donor as the batch effect, 
# while the kera_sub data using each sample as the batch effect
DFU_skin <- readRDS("step4_DFU_KC.rds")
DefaultAssay(DFU_skin) = "RNA"
DFU_skin <- DietSeurat(DFU_skin, assays = "RNA")

# check the overlapped genes and keep the overlapped genes
overgene <- intersect(rownames(DFU_skin), rownames(kera_sub))
length(overgene)

DFU_skin <- DFU_skin[overgene, ]
kera_sub <- kera_sub[overgene, ]

# integrate based on sample names. For kera_sub data, use sample ID, 
# while healthy adult data, use each donor as mentioned in the paper
DFU_skin$Project="DFU"
DFU_skin$oldSample=DFU_skin$Sample
DFU_skin$Sample=DFU_skin$Donor1
DFU_skin$CellType="DFU"

kera_sub$Project="Woundhealing"
kera_sub$Sample=kera_sub$orig.ident
kera_sub$CellType = kera_sub$upCellTypes
```


# 3. Prepare data for integration
```{r eval=TRUE}
all.DFU = SplitObject(DFU_skin, split.by = "Sample")
rm(DFU_skin);gc()
# normalize and identify variable features for each dataset independently
all.DFU <- lapply(X = all.DFU, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.DFU)) {
  all.DFU[[i]]$CC.Difference <- all.DFU[[i]]$S.Score - all.DFU[[i]]$G2M.Score
}


all.kera_sub = SplitObject(kera_sub, split.by = "Sample")
rm(kera_sub);gc()
all.kera_sub <- lapply(X = all.kera_sub, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.kera_sub)) {
  all.kera_sub[[i]]$CC.Difference <- all.kera_sub[[i]]$S.Score - all.kera_sub[[i]]$G2M.Score
}

alldata = append(all.DFU, all.kera_sub)
rm(all.DFU, all.kera_sub)
gc(verbose = F)

alldata <- lapply(X = alldata, FUN = SCTransform, method = "glmGamPoi", vars.to.regress = c("CC.Difference"))
```


# 4. Run harmony
```{r eval=TRUE}
# Run harmony using SCTransform
options(future.globals.maxSize = 100000 * 1024^2) 
features <- SelectIntegrationFeatures(object.list = alldata, nfeatures = 4000)
anno <- readRDS("humanAnnotation.rds")

alldata <- PrepSCTIntegration(object.list = alldata, anchor.features = features)
inteData <- merge(alldata[[1]], y = c(alldata[2:length(alldata)]), merge.data = TRUE)
VariableFeatures(inteData) <- features
rm(alldata);gc()

inteData <- RunPCA(inteData, npcs = 40, assay = "SCT")
ElbowPlot(inteData, ndims = 40)
table(inteData$Sample)
inteData <- RunHarmony(inteData, assay.use = "SCT", reduction = "pca", dims.use = 1:30, group.by.vars = "Sample", plot_convergence = TRUE)

inteData <- RunUMAP(inteData, dims = 1:30, assay = "SCT", reduction = "harmony")
DimPlot(inteData, group.by = "Sample") + NoAxes()

inteData = FindNeighbors(inteData, dims = 1:30, reduction = "harmony", k.param = 30)
inteData = FindClusters(inteData, resolution = 0.5)
inteData = FindClusters(inteData, resolution = 0.8)

DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T) +
  DimPlot(inteData, group.by = "CellType", label = T)

DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T, split.by = "Condition")  
DimPlot(inteData, group.by = "CellType", label = T, split.by = "Condition")

DefaultAssay(inteData) <- "RNA"
inteData <- NormalizeData(inteData)

# load the predicted cell type annotations
anno_pred <- data.table::fread("step3_predictedCellType_AnnotatedCellType.txt")
anno_pred_f <- colnames(inteData) %>% as.data.frame() %>% setNames("barcode") %>% left_join(., anno_pred)
inteData$oldDFUCellType <- anno_pred_f$CellType
DimPlot(inteData, group.by = "oldDFUCellType", label = T, split.by = "Condition")

inteData@reductions$pca@assay.used <- "RNA"
inteData@reductions$harmony@assay.used <- "RNA"
inteData@reductions$umap@assay.used <- "RNA"

inteData <- DietSeurat(inteData, assays = "RNA", dimreducs = c("harmony", "umap"))

# re-annotate the cell clusters
anno.cl <- list()
anno.cl$Bas_I = c(1,7) 
anno.cl$Bas_mig = c(8) 
anno.cl$Bas_prolif = c(9) 
anno.cl$Spi_I = c(10) 
anno.cl$Spi_II_a = c(0,5,3) 
anno.cl$Spi_II_b = c(4,6) 
anno.cl$Spi_III = c(14) 
anno.cl$Spi_mig = c(2) 
anno.cl$Gra_I = c(11) 
anno.cl$Other = c(12, 13) 

trans = rep(names(anno.cl), times = unlist(lapply(anno.cl, length)))
names(trans) = unlist(anno.cl)
inteData$newCellType = trans[as.character(inteData$SCT_snn_res.0.8)]
DimPlot(inteData, group.by = "newCellType", label = T) + ggtitle("newModi_CT")

saveRDS(inteData, "step4_DFU_Wound_inteKC.rds")
```


# Cell proportion analysis (Each bar filled with condition represents each cell type)
```{r}
inteData <- readRDS("step4_DFU_Wound_inteKC.rds")

# extract the data for pySCENIC analysis
inteData2 <- subset(inteData, subset = Project == "DFU")
mt <- inteData2@meta.data %>% rownames_to_column(var = "barcode") %>% select(1:17,42) %>% column_to_rownames(var = "barcode")
inteData2@meta.data <- mt
DimPlot(inteData2, group.by = "newCellType")
#saveRDS(inteData2, "step4_DFU_KC_pySCENIC.rds")

ct.cols <- c('#807dba','#9e9ac8','#ccebc5',
             '#fe9929','#fec44f','#fee391',
             '#fb8072','#b3de69','#fccde5')
               
# cell type proportion analysis
fac_levs <- c("Bas_I", "Bas_prolif", "Bas_mig", "Spi_I", "Spi_II_a", "Spi_II_b", "Spi_III", "Spi_mig", "Gra_I", "Other")
DimPlot(inteData, group.by = "newCellType", label = T, split.by = "Condition")

clusters <- fac_levs
df <- data.frame()
for(i in 1:length(clusters)){
  SmCell_sum <- table(inteData$Sample)
  tmp.df1 <- inteData@meta.data %>% subset(newCellType == clusters[i]) %>% select(Sample) %>% table()
  if(length(tmp.df1) == 32){
    #First normalize the total cell counts per Donor1
    cur_df <- as.data.frame(tmp.df1 / SmCell_sum)
    colnames(cur_df) <- c("Sample", "Freq")
    #Calculate the normalized proportion 
    cur_df$Freq <- cur_df$Freq * 1/(sum(cur_df$Freq))
    cur_df$Cluster <- clusters[i]
    df <- rbind(df, cur_df)
  } else {
    match.sample <- SmCell_sum[names(SmCell_sum) %in% names(tmp.df1)]
    cur_df <- as.data.frame(tmp.df1 / match.sample)
    colnames(cur_df) <- c("Sample", "Freq")
    cur_df$Freq <- cur_df$Freq * 1/(sum(cur_df$Freq))
    cur_df$Cluster <- clusters[i]
    df <- rbind(df, cur_df)
  }
}

df.group <- df %>% mutate(Sample = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Sample = gsub("^PWH[0-9]{2}", "", Sample)) %>% 
  group_by(Cluster, Sample) %>% 
  summarise(Freq = sum(Freq)) %>% ungroup()

df.group$Sample <- factor(df.group$Sample, levels = c("DFU_NH", "DFU_H", "H", "D0", "D1", "D7", "D30"))
df.group$Cluster <- factor(df.group$Cluster, levels = fac_levs)

ggplot(df.group, aes(x = Cluster, y = Freq, fill = Sample)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_brewer(palette = "Dark2") + # Paired or Set3 maximum variable = 12
  xlab('') +
  geom_hline(yintercept=0.25, linetype="dashed", color = "black") +
  geom_hline(yintercept=0.5, linetype="dashed", color = "black") +
  geom_hline(yintercept=0.75, linetype="dashed", color = "black") +
  scale_y_continuous(breaks = seq(0, 1, 0.2),
                     expand = c(0, 0.01),
                     name = 'Percentage') +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 10, color = "black", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10, color = "black")
  )

#pdf("step4_CellProportion.pdf", useDingbats = F, width = 5, height = 4)
#dev.off()
```


# Cell proportion analysis (Each bar filled with celltype represents each condition)
```{r}
FeaturePlot(inteData, features = c("FOSL1"), split.by = "Condition", cols = c("grey", "red"), order = T, ncol = 3)
VlnPlot(inteData, features = c("FOSL1"), group.by="newCellType",split.by = "Condition")
exp <- AverageExpression(inteData, assays = "RNA", features = c("FOSL1"), group.by = c("Condition", "newCellType"))
exp <- data.frame(CellType = colnames(exp$RNA), Exp = exp$RNA)
rownames(exp) <- NULL
exp <- exp %>% select(-1) %>% t() %>% as.data.frame() %>% select(1) 
exp <- exp %>% rownames_to_column(var = "com")

# step 1. Samples divided into cell types and their numbers
sm.tol <- table(inteData$Sample) %>% as.data.frame() %>% setNames(c("Sample", "TotalNumber"))

step1 <- table(inteData$Sample, inteData$newCellType) %>% as.data.frame() %>% setNames(c("Sample", "CellType", "Freq"))
step1$CellType <- as.character(step1$CellType) 
step1 <- step1 %>% filter(CellType != "Other")

# step 2. calculate the proportion of each cell type for each individual
step2 <- step1 %>% left_join(., sm.tol, by="Sample") %>% distinct() %>% 
  mutate(Prop=Freq/TotalNumber)

# step 3. calculate the total normalized proportions of each cell type per condition
df.group <- step2 %>% mutate(Sample = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Sample = gsub("^PWH[0-9]{2}", "", Sample)) %>% 
  group_by(Sample, CellType) %>% summarise(Freq=sum(Prop)) %>% 
  ungroup() %>% group_by(Sample) %>% 
  mutate(Freq_new = Freq/sum(Freq), lbl = scales::percent(Freq_new)) %>% ungroup()

df.group$Sample <- factor(df.group$Sample, levels = c("DFU_NH", "DFU_H", "H", "D0", "D1", "D7", "D30"))
df.group$CellType <- factor(df.group$CellType, levels = fac_levs)
p_cp_5 <- ggplot(df.group, aes(x = Sample, y = Freq_new, fill = CellType)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = ct.cols) + 
  xlab('') +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     expand = c(0, 0.01),
                     labels = c("0%", "20%", "40%", "60%", "80%", "100%"),
                     name = 'Percentage') +
  #geom_text(aes(label = lbl), 
  #          size = 4, 
  #          position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    axis.text.x = element_text(size = 14, color = "black", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 14, color = "black"),
    axis.title.y = element_text(size = 16, color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 12, color = "black")
  ) 
p_cp_5

#pdf("DFU_cellproportion_Endo.pdf", useDingbats = F, width = 3.5, height = 4.5)
p_cp_5
#dev.off()

# out the cell proportion
df.group.out <- step2 %>% mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% filter(Group %in% c("H", "DFU_H", "DFU_NH"))
data.table::fwrite(df.group.out, file = "/Users/zhuliu/Desktop/sc st/Versions_SC_ST_Project/V1_Figures_230120/Fig2_cellProportion/cellproportion_normalized_DFU.txt", sep = "\t")
```


# statistics of bas-/spi-mig clusters
```{r}
library(ggpubr)
bas_spi <- step2 %>% filter(CellType %in% c("Spi_mig")) %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  filter(Group %in% c("H", "DFU_H", "DFU_NH"))
  #filter(Group %in% c("D0", "D1", "D7", "D30"))

bas_spi$Group <- factor(bas_spi$Group, levels = c("H", "DFU_H", "DFU_NH"))
my_comparisons <- list(c("DFU_H", "DFU_NH"), c("DFU_H", "H"), c("DFU_NH", "H"))
#bas_spi$Group <- factor(bas_spi$Group, levels = c("D0", "D1", "D7", "D30"))
#my_comparisons <- list( c("D1", "D0"), c("D7", "D1"), c("D7", "D30") )
sigPlot2 <- ggviolin(bas_spi, x = "Group", y = "Prop", color = "Group", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
 add = c("jitter", "mean_sd")) + 
  stat_compare_means(comparisons = my_comparisons)# + #, label = "p.signif") + # Add pairwise comparisons p-value
  #stat_compare_means(label.y = 0.1) # global P value

sigPlot + sigPlot2 + plot_layout(guides = "collect") & theme(legend.position = "none")
#pdf("DFU_bas_spi_mig_cellproportion.pdf", useDingbats = F, width = 8, height = 4)
#dev.off()


# prepare the data for quasibinomial test
df.prop <- step2 %>% mutate(Condition = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Condition = gsub("^PWH[0-9]{2}", "", Condition)) %>% 
  filter(CellType %in% c("Spi_mig")) %>% 
  filter(Condition %in% c("DFU_NH", "DFU_H")) #, "H", "DFU_NH", "DFU_H"

df.prop$Condition <- factor(df.prop$Condition, levels = c("H", "DFU_NH", "DFU_H"))
test.quasi = glm(formula = Prop ~ Condition, data = df.prop, family=quasibinomial)
print(summary(test.quasi))
anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
#pav_tot_val <- anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
```


# Summary the total expressed FOSL1+ cells
```{r}
library(ggpubr)
table(inteData$newCellType)
DimPlot(inteData, group.by = "newCellType")
genes_all <- FetchData(inteData, vars = c("Condition", "Sample", "newCellType",
                                          "FOSL1"), slot = "data")

genes_all_f <- genes_all %>% filter(FOSL1 > 0.1)
table(genes_all_f$newCellType, genes_all_f$Condition)

fosl1exp <- table(genes_all_f$newCellType, genes_all_f$Sample) %>% as.data.frame()

table(inteData$newCellType, inteData$Sample)
table(inteData$Condition)
smTotal <- table(inteData$Sample) %>% as.data.frame()
table(inteData$newCellType, inteData$Sample)

# add the total number into fosl1exp
fosl1_tol <- fosl1exp %>% left_join(., smTotal, by=c("Var2" = "Var1")) %>% 
  setNames(c("CellType", "Sample", "Freq", "Total")) %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  filter(Group %in% c("H", "DFU_H", "DFU_NH")) %>% mutate(Prop = Freq / Total)

# Bas_mig
## First calculate the mean value of skin
skin.avg <- fosl1_tol %>% filter(CellType %in% c("Spi_mig")) %>% group_by(Group) %>% summarize(mean(Prop))
skin.avg
wds.bas <- fosl1_tol %>% filter(CellType %in% c("Spi_mig")) %>% mutate(NormProp = Prop /skin.avg$`mean(Prop)`[3])
wds.bas$Group <- factor(wds.bas$Group, levels = c("H", "DFU_H", "DFU_NH"))
wds.bas.summary <- wds.bas %>% group_by(Group) %>% 
  summarise(sd = sd(NormProp, na.rm = TRUE), NormProp = mean(NormProp))
wds.bas.summary

p2.wds <- ggplot(wds.bas, aes(Group, NormProp)) +
  geom_col(data = wds.bas.summary, fill = NA, color = "black") +
  geom_jitter( position = position_jitter(0.1), color = "black") + 
  geom_errorbar( aes(ymin = NormProp-sd, ymax = NormProp+sd), 
                 data = wds.bas.summary, width = 0.2) +
  #scale_y_continuous(limits = c(0,14),breaks = c(0, 4, 8,12,16)) +
  theme_classic()
p1.wds + p2.wds
# add the significance using t.test
p1 <- p1.wds + stat_compare_means(comparisons = my_comparisons, label = "p.signif", method = "t.test")
p2 <- p2.wds + stat_compare_means(comparisons = my_comparisons, label = "p.signif", method = "t.test")
pdf("step4_FOSL1_positiveCells.pdf", useDingbats = FALSE, width = 4, height = 3)
p1 + p2
dev.off()

# add the significance of groups (Pair-wise comparisons)
# prepare the data for significance test
df.prop <- wds.bas %>% filter(Group %in% c("DFU_H", "DFU_NH"))
df.prop$Group <- factor(df.prop$Group, levels = c("DFU_H", "DFU_NH"))

# anova test
test.sum <- aov(NormProp ~ Group, data = df.prop)
summary(test.sum)

#t.test(NormProp ~ Group, data = df.prop)
#wilcox.test(NormProp ~ Group, data = df.prop)

# quasibinomial test
test.quasi = glm(formula = Prop ~ Group, data = df.prop, family=quasibinomial)
print(summary(test.quasi))
anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
```

# SessionInfo
```{r}
sessionInfo()
```

