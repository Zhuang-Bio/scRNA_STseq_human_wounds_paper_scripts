---
title: "Diabetic foot ulcers"
author: "Zhuang Liu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true #add a table of contents (TOC)
    toc_depth: 3 #headers' level in the toc
    toc_float: true #toc visible even when scrolled
    theme: lumen
    highlight: tango
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center', fig.width=12, fig.height = 6, warning=FALSE, message=FALSE)
```

Download the data from Theocharidis et al. paper (GSE165816) https://www.nature.com/articles/s41467-021-27801-8 

```{r warning=FALSE, message=FALSE}
library(Seurat)
library(SeuratObject)
library(SeuratDisk)
library(tidyverse)
library(patchwork)
library(sctransform)
library(harmony)
```


# 1. load the data
## 1.1 Quality control
```{r eval=TRUE}
inteData <- readRDS("step1_diabetic_foot_ulcer_skin_integrated_harmony.rds")

DimPlot(inteData, group.by = "SCT_snn_res.1", label = T)
# re-annotate the cell clusters
anno.cl <- list()
anno.cl$HE_Fibro = c(12) #MMP3, MMP1, CHI3L2, CHI3L1, TNFAIP6
anno.cl$FB_I_III_DFU = c(2,8,25) #ASPN, POSTN, WISP2, IGFBP6, COMP, APCDD1, PI16, ELN
anno.cl$FB_II_DFU = c(1,18) #APOD, CXCL14, C3, APOE, C2orf40
anno.cl$NKT_Lympho = c(5) #CD69, IL32, CD52, IL7R, PTPRC, NKG7
anno.cl$M1_Macro = c(11) #IL1B,EREG,
anno.cl$M2_Macro = c(9) #C1QA, C1QB, CD14, CD163
anno.cl$B_Lympho = c(23) #CD79A,MS4A1
anno.cl$VasEndo_art = c(16) #"IGFBP3","HEY1","SEMA3G"
anno.cl$VasEndo_ven = c(3) #RGCC
anno.cl$LymphEndo = c(21)
anno.cl$SMC2 = c(15) #MKI67, CENPF
anno.cl$SMC1 = c(0,4,7,13,24)
anno.cl$Melano_Schwann = c(19) #DCT, SOX10, SOX2
anno.cl$Mast = c(20) #TPSAB1, MS4A2
anno.cl$Sweat_Seba = c(17) #DCD, SCGB2A2, MUCL1, KRT19
anno.cl$OtherKera = c(14,22) #KRT17, KRT6B, KRT6A, S100A2, KRT16
anno.cl$BasalKera = c(10) #COL17A1, KRT5
anno.cl$DiffKera = c(6) #KRT1, KRT10, KRT16, KRT6A

trans = rep(names(anno.cl), times = unlist(lapply(anno.cl, length)))
names(trans) = unlist(anno.cl)
inteData$CellType = trans[as.character(inteData$SCT_snn_res.1)]
#DimPlot(inteData, group.by = "SCT_snn_res.1", cols = ct.cols, label = T)
DimPlot(inteData, group.by = "CellType", label = T) + ggtitle("") + NoLegend()

fac_levs <- c("BasalKera", "DiffKera", "OtherKera", "Sweat_Seba", 
              "HE_Fibro", "FB_I_III_DFU", "FB_II_DFU", "SMC1", "SMC2",
              "M1_Macro", "M2_Macro", "B_Lympho", "NKT_Lympho", 
              "LymphEndo", "VasEndo_art", "VasEndo_ven", "Melano_Schwann", "Mast")
ct.cols <- c("#d94701", "#fdae61", "#fd8d3c", "#35978f", 
             "#0570b0", "#33A02C", "#72BF5A", "#B2DF8A", "#3690c0", 
             "#f768a1", "#d4b9da", "#92c5de", "#d1e5f0",
             "#c0a700", "#1a9850", "#fb9a99", "#8d4720", "#fdbe85"
             )
names(ct.cols) <- fac_levs

inteData$CellType <- factor(inteData$CellType, levels = fac_levs)
DimPlot(inteData, group.by = "CellType", label = T, cols = ct.cols) + ggtitle("") + NoLegend()

DefaultAssay(inteData) <- "RNA"
inteData <- DietSeurat(inteData, assays = "RNA")

table(inteData$CellType)

# extract the FB-related clusters
DFU_skin <- subset(inteData, subset = CellType == "HE_Fibro" | CellType == "FB_I_III_DFU" | CellType == "FB_II_DFU")
DFU_skin@meta.data <- droplevels(DFU_skin@meta.data)
DFU_skin$SCT_snn_res.0.8 <- NULL
DFU_skin$SCT_snn_res.1 <- NULL
DFU_skin$seurat_clusters <- NULL
DFU_skin$SCT_snn_res.0.5 <- NULL
DFU_skin$nCount_SCT <- NULL
DFU_skin$nFeature_SCT <- NULL

rm(inteData);gc()
```

## 1.2 Wound KC data
```{r}
output_path <- "/Users/zhuliu/Desktop/scRNA_STseq/proj_10X_woundhealing/03_results/01-Seurat-PreAnalysis/02_Seurat_BatchCorrection/s3_Seurat_subFibroblasts/"
fib_sub <- readRDS(paste0(output_path, "s1_clean_fibroblast.rds"))

# re-annotate the cell clusters
fac_levs <- c("FB-I(POSTN+COL11A1+)", "FB-I(POSTN+MMP11+)", 
              "FB-I(POSTN+COL4A1+)", "FB-I(SFRP4+COMP+)", 
              "FB-II(APOD+ITM2A+)", "FB-II(APOE+CCL19+)",
              "FB-III(ELN+LEPR+)", 
              "FB-prolif",
              "FB(SFRP1+CRABP1+)", "FB(ELN+SFRP4+)")
current_cluster_ids <- c(0,2,8,4,
                         3,5,1,6,9,7) # List of current cluster IDs
tmp <- plyr::mapvalues(x=fib_sub$SCT_snn_res.0.5, from=current_cluster_ids, to=fac_levs)
fib_sub$upCellTypes <- tmp
fib_sub$upCellTypes <- factor(fib_sub$upCellTypes, levels = fac_levs)

# set the colors for the fibroblasts
ct.cols <- c("#57a9e2", "#31c783", "#c6cc85", "#c072fd", "#e36767", 
               "#aa6d60", "#ff9a41", "#eca1d5", "#31d7e8", "#b0b0b0")
names(ct.cols) <- fac_levs

DimPlot(fib_sub, group.by = "upCellTypes", cols = ct.cols)
fib_sub <- DietSeurat(fib_sub, assays = "RNA")
```


# 2. Integrate the DFU skin data with fib_sub data
```{r eval=TRUE}
# DFU skin integration using the donor as the batch effect, 
# while the fib_sub data using each sample as the batch effect
DefaultAssay(DFU_skin) = "RNA"
DFU_skin <- DietSeurat(DFU_skin, assays = "RNA")

# check the overlapped genes and keep the overlapped genes
overgene <- intersect(rownames(DFU_skin), rownames(fib_sub))
length(overgene)

DFU_skin <- DFU_skin[overgene, ]
fib_sub <- fib_sub[overgene, ]

# integrate based on sample names. For fib_sub data, use sample ID, 
# while healthy adult data, use each donor as mentioned in the paper
DFU_skin$Project="DFU"
DFU_skin$oldSample=DFU_skin$Sample
DFU_skin$Sample=DFU_skin$Donor1
DFU_skin$CellType=DFU_skin$CellType

fib_sub$Project="Woundhealing"
fib_sub$Sample=fib_sub$orig.ident
fib_sub$CellType = fib_sub$upCellTypes
```


# 3. Prepare data for integration
```{r eval=TRUE}
all.DFU = SplitObject(DFU_skin, split.by = "Sample")
rm(DFU_skin);gc()
# normalize and identify variable features for each dataset independently
all.DFU <- lapply(X = all.DFU, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.DFU)) {
  all.DFU[[i]]$CC.Difference <- all.DFU[[i]]$S.Score - all.DFU[[i]]$G2M.Score
}


all.fib_sub = SplitObject(fib_sub, split.by = "Sample")
rm(fib_sub);gc()
all.fib_sub <- lapply(X = all.fib_sub, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.fib_sub)) {
  all.fib_sub[[i]]$CC.Difference <- all.fib_sub[[i]]$S.Score - all.fib_sub[[i]]$G2M.Score
}

alldata = append(all.DFU, all.fib_sub)
rm(all.DFU, all.fib_sub)
gc(verbose = F)

alldata <- lapply(X = alldata, FUN = SCTransform, method = "glmGamPoi", vars.to.regress = c("CC.Difference"))
```


# 4. Run harmony, clustering, marker genes
```{r eval=TRUE}
# Run harmony using SCTransform
options(future.globals.maxSize = 100000 * 1024^2) 
features <- SelectIntegrationFeatures(object.list = alldata, nfeatures = 4000)
#anno <- readRDS("humanAnnotation.rds")

alldata <- PrepSCTIntegration(object.list = alldata, anchor.features = features)
inteData <- merge(alldata[[1]], y = c(alldata[2:length(alldata)]), merge.data = TRUE)
VariableFeatures(inteData) <- features
rm(alldata);gc()

inteData <- RunPCA(inteData, npcs = 40, assay = "SCT")
ElbowPlot(inteData, ndims = 40)
table(inteData$Sample)
inteData <- RunHarmony(inteData, assay.use = "SCT", reduction = "pca", dims.use = 1:30, group.by.vars = "Sample", plot_convergence = TRUE)

inteData <- RunUMAP(inteData, dims = 1:30, assay = "SCT", reduction = "harmony")
DimPlot(inteData, group.by = "Sample") + NoAxes()

inteData = FindNeighbors(inteData, dims = 1:30, reduction = "harmony", k.param = 20)
inteData = FindClusters(inteData, resolution = 0.5)
inteData = FindClusters(inteData, resolution = 0.8)
inteData = FindClusters(inteData, resolution = 0.3)
inteData = FindClusters(inteData, resolution = 1)
DimPlot(inteData, group.by = "SCT_snn_res.1", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.0.5", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.0.3", label = T)

DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T) +
  DimPlot(inteData, group.by = "CellType", label = T)

DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T, split.by = "Condition")  
DimPlot(inteData, group.by = "CellType", label = T, split.by = "Condition")

DimPlot(inteData, group.by = "CellType", label = T, split.by = "Project")
FeaturePlot(inteData, features = c("MKI67"), cols = c("grey90", "red"))
table(inteData$SCT_snn_res.0.8, inteData$Condition)

#saveRDS(inteData, "step5_DFU_Wound_inteFB.rds")

# Find markers
Idents(inteData) <- "SCT_snn_res.0.5" 
table(inteData$SCT_snn_res.0.5)
markers2 <- FindAllMarkers(
  inteData,
  only.pos = TRUE,
  min.pct = 0.25,  #min.pct = 0.5, logfc.threshold = 0.5,
  logfc.threshold = 0.3,
  test.use = "MAST") 
cluster_markers_anno2 <- markers2 %>% arrange(cluster, desc(avg_log2FC))
data.table::fwrite(cluster_markers_anno2, "step5_DFU_Wound_inteFB_mg0.5.txt", sep="\t")

# Find markers
Idents(inteData) <- "SCT_snn_res.0.8" 
table(inteData$SCT_snn_res.0.8)
markers1 <- FindAllMarkers(
  inteData,
  only.pos = TRUE,
  min.pct = 0.25,  #min.pct = 0.5, logfc.threshold = 0.5,
  logfc.threshold = 0.3,
  test.use = "MAST") 
cluster_markers_anno1 <- markers1 %>% arrange(cluster, desc(avg_log2FC))
data.table::fwrite(cluster_markers_anno1, "step5_DFU_Wound_inteFB_mg0.8.txt", sep="\t")
```


# 5. re-annotate clusters
```{r eval=TRUE}
rm(list = ls())
inteData <- readRDS("step5_DFU_Wound_inteFB.rds")
inteData
DefaultAssay(inteData) <- "RNA"
inteData <- NormalizeData(inteData)
mg05 <- data.table::fread("step5_DFU_Wound_inteFB_mg0.5.txt")
mg08 <- data.table::fread("step5_DFU_Wound_inteFB_mg0.8.txt")
mg08$cluster <- factor(mg08$cluster)
table(inteData$SCT_snn_res.0.8, inteData$Condition)
DimPlot(inteData, group.by = "CellType", split.by = "Project", label = T)
FeaturePlot(inteData, features = c("POSTN", "COL11A1", "MMP11", "MMP1", "MMP3", "CHI3L1"), cols = c("grey90", "red"), split.by = "Condition") 
VlnPlot(inteData, features = c("POSTN", "COL11A1", "MMP11"), group.by = "Condition")
table(inteData@meta.data %>% filter(CellType == "HE_Fibro") %>% pull(SCT_snn_res.0.8))
DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T)

genes <- c("POSTN", "ADAM12", "ASPN", "COL16A1", "COL11A1", 
           "MMP11", "ISG15", "IER5", "IFI6",
           "COL4A1", "COL4A2", 
           "IGFBP6", "COMP", "EGFL6", 
           "APOD", "FGF7", "PLA2G2A", "ITM2A", 
           "C3", "APOE", "CCL19", "CD74", "COL6A5", 
           "LEPR", "PLPP3", "CD9", "SLIT3", "DPP4", 
           "PCLAF", "MKI67",
           "SFRP1", "CRABP1", "TNN", "COCH", "G0S2",
           "ELN", "AKR1C1", "GPRC5A", "SFRP4")

plot_marker <- DotPlot(inteData, features = genes, 
                       group.by = "SCT_snn_res.0.8", cols = c("white", "#cb181d"), 
                       dot.scale = 4, col.min = 0, dot.min = 0.1
) + theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.border = element_rect(colour = "black", fill=NA)) + labs(x="", y="")
plot_marker

FeaturePlot(inteData, features = c("MKI67", "CHI3L1"), cols = c("grey90", "red"), split.by = "Condition") 
FeaturePlot(inteData, features = c("ELN", "SFRP4", "SFRP1","APOD", "APOE", "COMP", "LEPR", "MMP11", "COL4A1", "CRABP1","POSTN","CCL19"), cols = c("grey90", "red")) 

# re-annotate the cell clusters
anno.cl <- list()
anno.cl$FB_I_POSTN_COL11A1 = c(0,3,5)
anno.cl$FB_I_POSTN_MMP11 = c(2,9,13,19,20)
anno.cl$FB_I_POSTN_COL4A1 = c(12) 
anno.cl$FB_I_SFRP4_COMP = c(8,14)

anno.cl$FB_II_APOD_ITM2A = c(6,15)
anno.cl$FB_II_APOE_CCL19 = c(1,16,17)

anno.cl$FB_III_ELN_LEPR = c(10,7) 
#anno.cl$FB_prolif = c(9)
anno.cl$SFRP1_CRABP1 = c(11)
anno.cl$ELN_SFRP4 = c(4,18)

# re-annotate the clusters into four main clusters
anno.cl <- list()
anno.cl$FB_I = c(0,2,3,5,9,13,14,19,20)
anno.cl$FB_II = c(4,7,8,10,18)
anno.cl$FB_III = c(1,6,11,12,15,16,17)

trans = rep(names(anno.cl), times = unlist(lapply(anno.cl, length)))
names(trans) = unlist(anno.cl)

inteData$newCellType = trans[as.character(inteData$SCT_snn_res.0.8)]
table(inteData$newCellType, inteData$Condition)
DimPlot(inteData, group.by = "newCellType", label = T, label.size = 5) + ggtitle("newModi_CT")
DimPlot(inteData, group.by = "newCellType", label = T, split.by = "Condition") + ggtitle("newModi_CT")
```


# Summary the total expressed FB+ cells
```{r}
table(inteData$newCellType)
DimPlot(inteData, group.by = "newCellType")
genes_all <- FetchData(inteData, vars = c("Condition", "Sample", "newCellType",
                                          "POSTN", "COL11A1", "MMP11"), slot = "data")

#genes_all_f <- genes_all %>% filter((POSTN > 0.5 & COL11A1 > 0.5 & MMP11 > 0.5))
genes_all_f <- genes_all %>% filter((POSTN > 0.5 & COL11A1 > 0.5))
genes_all_f <- genes_all %>% filter((POSTN > 0.5 & MMP11 > 0.5))
table(genes_all_f$newCellType, genes_all_f$Condition)

DimPlot(inteData, cells.highlight = rownames(genes_all_f), split.by = "Condition")
smTotal <- table(inteData$Sample) %>% as.data.frame()
expPostive <- table(genes_all_f$newCellType, genes_all_f$Sample) %>% as.data.frame()

# add the total number into expPostive
expPostive_tol <- expPostive %>% left_join(., smTotal, by=c("Var2" = "Var1")) %>% 
  setNames(c("CellType", "Sample", "Freq", "Total")) %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  filter(Group %in% c("H", "DFU_H", "DFU_NH")) %>% mutate(Prop = Freq / Total)

## First calculate the mean value of skin
skin.avg <- expPostive_tol %>% filter(CellType %in% c("FB_I")) %>% group_by(Group) %>% summarize(mean(Prop))
skin.avg
wds.bas <- expPostive_tol %>% filter(CellType %in% c("FB_I")) %>% mutate(NormProp = Prop /skin.avg$`mean(Prop)`[3])
wds.bas$Group <- factor(wds.bas$Group, levels = c("H", "DFU_H", "DFU_NH"))
wds.bas.summary <- wds.bas %>% group_by(Group) %>% 
  summarise(sd = sd(NormProp, na.rm = TRUE), NormProp = mean(NormProp))
wds.bas.summary

p2.wds <- ggplot(wds.bas, aes(Group, NormProp)) +
  geom_col(data = wds.bas.summary, fill = NA, color = "black") +
  #scale_y_break(c(4.3,8)) +
  geom_jitter( position = position_jitter(0.1), color = "black") + 
  geom_errorbar( aes(ymin = NormProp-sd, ymax = NormProp+sd), 
                 data = wds.bas.summary, width = 0.2) +
 # scale_y_continuous(limits = c(0,14),breaks = c(0, 4, 8,12,16)) +
  theme_classic()
p2.wds

# add the significance of groups
#my_comparisons <- list(c("D1", "D0"), c("D7", "D0"), c("D30", "D0"))
#p1 + stat_compare_means(comparisons = my_comparisons, label = "p.signif")

# prepare the data for significance test
df.prop <- wds.bas %>% filter(Group %in% c("DFU_H", "DFU_NH"))
df.prop$Group <- factor(df.prop$Group, levels = c("DFU_H", "DFU_NH"))

test.sum <- aov(NormProp ~ Group, data = df.prop)
summary(test.sum)

#t.test(NormProp ~ Group, data = df.prop)
wilcox.test(NormProp ~ Group, data = df.prop)

test.quasi = glm(formula = Prop ~ Group, data = df.prop, family=quasibinomial)
print(summary(test.quasi))
anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
```

# 6. Cell proportion analysis (Each bar filled with celltype represents each condition)
```{r}
# step 1. Samples divided into cell types and their numbers
sm.tol <- table(inteData$Sample) %>% as.data.frame() %>% setNames(c("Sample", "TotalNumber"))

step1 <- table(inteData$Sample, inteData$newCellType) %>% as.data.frame() %>% setNames(c("Sample", "CellType", "Freq"))
step1$CellType <- as.character(step1$CellType) 
step1 <- step1 %>% filter(CellType != "Other")

# step 2. calculate the proportion of each cell type for each individual
step2 <- step1 %>% left_join(., sm.tol, by="Sample") %>% distinct() %>% 
  mutate(Prop=Freq/TotalNumber)

# step 3. calculate the total normalized proportions of each cell type per condition
df.group <- step2 %>% mutate(Sample = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Sample = gsub("^PWH[0-9]{2}", "", Sample)) %>% 
  group_by(Sample, CellType) %>% summarise(Freq=sum(Prop)) %>% 
  ungroup() %>% group_by(Sample) %>% 
  mutate(Freq_new = Freq/sum(Freq), lbl = scales::percent(Freq_new)) %>% ungroup()

df.group$Sample <- factor(df.group$Sample, levels = c("H", "DFU_H", "DFU_NH", "D0", "D1", "D7", "D30"))
fac_levs <- unname(trans) %>% unique()
# set the colors for the fibroblasts
ct.cols <- c("#57a9e2", "#31c783", "#c6cc85", "#c072fd", "#e36767", 
               "#aa6d60", "#ff9a41", "#31d7e8", "#b0b0b0")
names(ct.cols) <- fac_levs
df.group$CellType <- factor(df.group$CellType, levels = fac_levs)
df.group <- df.group %>% dplyr::filter(Sample %in% c("DFU_NH", "DFU_H", "H"))
p_cp_5 <- ggplot(df.group, aes(x = Sample, y = Freq_new, fill = CellType)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = ct.cols) + 
  xlab('') +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     expand = c(0, 0.01),
                     labels = c("0%", "20%", "40%", "60%", "80%", "100%"),
                     name = 'Percentage') +
  #geom_text(aes(label = lbl), 
  #          size = 4, 
  #          position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    axis.text.x = element_text(size = 14, color = "black", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 14, color = "black"),
    axis.title.y = element_text(size = 16, color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 12, color = "black")
  ) 
p_cp_5

#pdf("step5_DFU_Wound_inteFB_cellproportion_sub.pdf", useDingbats = F, width = 5, height = 4)
p_cp_5
#dev.off()


# check the significance
step2_sig <- step2 %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  dplyr::filter(CellType %in% c("ELN_SFRP4")) %>% # choose the cell type
  dplyr::filter(Group %in% c("DFU_NH", "DFU_H")) # choose the pair-wise groups

step2_sig <- step2 %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  dplyr::filter(CellType %in% c("ELN_SFRP4")) %>% # choose the cell type
  dplyr::filter(Group %in% c("H", "DFU_H")) # choose the pair-wise groups

test.quasi = glm(formula = Prop ~ Group, data = step2_sig, family=quasibinomial)
print(summary(test.quasi))
anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
#pav_tot_val <- anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
```


# 7. statistics of marker genes scores
```{r}
###################################################
# Fig 5 Calculate the scores of fibroblast clusters
# read the marker genes from scRNA-seq data
markers <- data.table::fread("/Users/zhuliu/Desktop/scRNA_STseq/proj_10X_woundhealing/03_results/01-Seurat-PreAnalysis/02_Seurat_BatchCorrection/s3_Seurat_subFibroblasts/s1_clean_fibroblast_mg_res05.txt") %>% 
  group_by(cluster) %>% arrange(cluster, desc(avg_log2FC)) %>% ungroup()
# re-annotate the cell clusters
fac_levs <- c("FB-I(POSTN+COL11A1+)", "FB-I(POSTN+MMP11+)", 
              "FB-I(POSTN+COL4A1+)", "FB-I(SFRP4+COMP+)", 
              "FB-II(APOD+ITM2A+)", "FB-II(APOE+CCL19+)",
              "FB-III(ELN+LEPR+)", 
              "FB-prolif",
              "FB(SFRP1+CRABP1+)", "FB(ELN+SFRP4+)")
current_cluster_ids <- c(0,2,8,4,
                         3,5,1,6,9,7) # List of current cluster IDs
tmp <- plyr::mapvalues(x=markers$cluster, from=current_cluster_ids, to=fac_levs)

markers$CellTypes <- tmp


m1gene_sig <- list(FB1= unique(c(markers %>% dplyr::filter(CellTypes == "FB-I(POSTN+COL11A1+)") %>%
                                  top_n(100, avg_log2FC) %>% pull(gene))))
m2gene_sig <- list(FB2= unique(c(markers %>% dplyr::filter(CellTypes == "FB-I(POSTN+MMP11+)") %>%
                                  top_n(100, avg_log2FC) %>% pull(gene))))


inteData <- AddModuleScore(object = inteData, features = m1gene_sig, name = "FB1_mesen_Score") 
inteData <- AddModuleScore(object = inteData, features = m2gene_sig, name = "FB1_mmp_Score") 

VlnPlot(
  inteData,
  features = c("FB1_mesen_Score1"),
  ncol = 1, pt.size=0, group.by = "newCellType", split.by = "Condition") +
  VlnPlot(
  inteData,
  features = c("FB1_mmp_Score1"),
  ncol = 1, pt.size=0, group.by = "newCellType", split.by = "Condition")

library(ggpubr)
cluster_score <- inteData@meta.data %>% select(7, 37:39) %>% 
  mutate(Group = gsub("H[0-9]$", "H", Sample)) %>% 
  mutate(Group = gsub("^PWH[0-9]{2}", "", Group)) %>% 
  filter(Group %in% c("H", "DFU_H", "DFU_NH"))

cluster_score$Group <- factor(cluster_score$Group, levels = c("H", "DFU_H", "DFU_NH"))
cluster_score$newCellType <- factor(cluster_score$newCellType, levels = c("FB_I", "FB_II", "FB_III"))
my_comparisons <- list(c("DFU_H", "DFU_NH"), c("DFU_H", "H"), c("DFU_NH", "H"))

sigPlot1 <- ggviolin(cluster_score, x = "newCellType", y = "FB1_mesen_Score1", fill = "Group", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
 add = c("mean_sd")) + 
  stat_compare_means(comparisons = my_comparisons, )

sigPlot2 <- ggviolin(cluster_score, x = "newCellType", y = "FB1_mmp_Score1", fill = "Group", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
 add = c("mean_sd")) + 
  stat_compare_means(comparisons = my_comparisons)

sigPlot1 + sigPlot2 + plot_layout(guides = "collect") & theme(legend.position = "right")

pdf("step5_DFU_Wound_inteFB_Top100mgScores.pdf", useDingbats = F, width = 12, height = 3)
dev.off()


# prepare the data for quasibinomial test
df.prop <- cluster_score# %>% dplyr::filter(newCellType == "FB_III")
(ggviolin(df.prop, x = "Group", y = "FB1_mesen_Score1", fill = "Group",palette = c("#00AFBB", "#E7B800", "#FC4E07"),
 add = c("mean_sd")) + 
  stat_compare_means(comparisons = my_comparisons, label = "p.signif")) +
  (ggviolin(df.prop, x = "Group", y = "FB1_mmp_Score1", fill = "Group", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
 add = c("mean_sd")) + 
  stat_compare_means(comparisons = my_comparisons, label = "p.signif"))
#pdf("step5_DFU_Wound_inteFB_Top100mgScores_allFB_sig.pdf", useDingbats = F, width = 6, height = 3)
#dev.off()

df.prop$Condition <- factor(df.prop$Condition, levels = c("H", "DFU_NH", "DFU_H"))
test.quasi = glm(formula = Prop ~ Condition, data = df.prop, family=quasibinomial)
print(summary(test.quasi))
anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
#pav_tot_val <- anova(test.quasi, test = "LRT")$`Pr(>Chi)`[2]
```


# SessionInfo
```{r}
sessionInfo()
```

