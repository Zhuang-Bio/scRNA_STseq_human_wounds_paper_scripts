---
title: "Integration of wounds and published skin data"
author: "Zhuang Liu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true #add a table of contents (TOC)
    toc_depth: 3 #headers' level in the toc
    toc_float: true #toc visible even when scrolled
    theme: lumen
    highlight: tango
    code_folding: show
editor_options: 
  chunk_output_type: console
---
---
title: "Integration of wounds and published skin data"
author: "Zhuang Liu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true #add a table of contents (TOC)
    toc_depth: 3 #headers' level in the toc
    toc_float: true #toc visible even when scrolled
    theme: lumen
    highlight: tango
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center', fig.width=12, fig.height = 6, warning=FALSE, message=FALSE)
```

```{r warning=FALSE, message=FALSE}
library(Seurat)
library(SeuratObject)
library(SeuratDisk)
library(tidyverse)
library(patchwork)
library(harmony)
```

## 1. Colors for cell clusters
```{r eval=TRUE}
# human wounds data
wds_fact_lev <- c("Bas-I", "Bas-II", "Bas-prolif", "Bas-mig", 
                  "Spi-I", "Spi-II", "Spi-mig", 
                  "Gra-I", "HF", 
                  "MEL", 
                  "FB-I", "FB-II", "FB-III", "FB-prolif", 
                  "Schwann", "PC-vSMC", "LE", "VE", 
                  "NK-cell", "Th", "Plasma_Bcell", "Mast-cell", 
                  "Mono-Mac", "cDC1", "cDC2", "DC3", "LC")
wds_ct.cols <- c("#d94701", "#fdae61", "#fd8d3c", "#fdbe85", #Basal clusters
             "#33A02C", "#72BF5A", "#B2DF8A", #Spinous clusters
             "#f768a1", "#d4b9da", #Granular, Hair follicle
             "#737373", #MEL
             "#0570b0", "#3690c0", "#92c5de", "#d1e5f0", #Fibroblast clusters
             "#c0a700", "#1a9850", "#fb9a99", "#8d4720",  # Schwann,PCvSMC,LE,VE
             "#35978f", "#41b6c4", "#80cdc1","#df65b0", #"NK-cell", "Th",... 
             "#dd3497", "#807dba","#6a3d9a","#9e9ac8", "#b15928" #"Mono-Mac",...
)
# add the color names using new cell types
names(wds_ct.cols) <- wds_fact_lev
```

# Quality control
```{r eval=TRUE}
DFU_skin <- readRDS("step0_rawDFUdata.rds")
# filter the cells (use the sample criteria as in our wounds dataset)
keep = colnames(DFU_skin)[DFU_skin$nFeature_RNA > 500 & DFU_skin$percent_mito < 20 & DFU_skin$percent_hb < 10 & DFU_skin$nCount_RNA > 1000 & DFU_skin$nCount_RNA < 150000]
DFU_skin = DFU_skin[, keep]

table(DFU_skin$Donor1, DFU_skin$Condition)

# remove the MT genes
DFU_skin <- DFU_skin[!grepl("^MT-", rownames(DFU_skin)), ]

# Filter Malat
DFU_skin <- DFU_skin[!grepl("MALAT1", rownames(DFU_skin)), ]

# filter hemoglobin genes
DFU_skin <- DFU_skin[!grepl("^HB[^(PES)]", rownames(DFU_skin)), ]
```


# 2. Integrate the DFU skin data with wounds data
```{r eval=TRUE}
# DFU skin integration using the donor as the batch effect, 
# while the wounds data using each sample as the batch effect

DefaultAssay(DFU_skin) = "RNA"
DFU_skin <- DietSeurat(DFU_skin, assays = "RNA")

wounds <- readRDS("../step4_wounds.rds")
DimPlot(wounds, group.by = "newCellTypes", label = F, raster=TRUE) + ggtitle("")
wounds = DietSeurat(wounds, assays = "RNA")

# check the overlapped genes and keep the overlapped genes
overgene <- intersect(rownames(DFU_skin), rownames(wounds))
length(overgene)

DFU_skin <- DFU_skin[overgene, ]
wounds <- wounds[overgene, ]

# integrate based on sample names. For wounds data, use sample ID, 
# while healthy adult data, use each donor as mentioned in the paper
DFU_skin$Project="DFU"
DFU_skin$oldSample=DFU_skin$Sample
DFU_skin$Sample=DFU_skin$Donor1
DFU_skin$CellType="DFU"

wounds$Project="Woundhealing"
wounds$Sample=wounds$orig.ident
wounds$CellType = wounds$newCellTypes
```


# 3. Prepare data for integration
```{r eval=TRUE}
all.DFU = SplitObject(DFU_skin, split.by = "Sample")
rm(DFU_skin);gc()
# normalize and identify variable features for each dataset independently
all.DFU <- lapply(X = all.DFU, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.DFU)) {
  all.DFU[[i]]$CC.Difference <- all.DFU[[i]]$S.Score - all.DFU[[i]]$G2M.Score
}


all.wounds = SplitObject(wounds, split.by = "Sample")
rm(wounds);gc()
all.wounds <- lapply(X = all.wounds, FUN = function(x) {
    x <- NormalizeData(x)
    x <- CellCycleScoring(x, s.features = cc.genes.updated.2019$s.genes, g2m.features = cc.genes.updated.2019$g2m.genes, set.ident = F)
})
for (i in seq_along(all.wounds)) {
  all.wounds[[i]]$CC.Difference <- all.wounds[[i]]$S.Score - all.wounds[[i]]$G2M.Score
}

alldata = append(all.DFU, all.wounds)
rm(all.DFU, all.wounds)
gc(verbose = F)

alldata <- lapply(X = alldata, FUN = SCTransform, method = "glmGamPoi", vars.to.regress = c("CC.Difference"))
```


# 4. Run harmony
```{r eval=TRUE}
# Run harmony using SCTransform
options(future.globals.maxSize = 100000 * 1024^2) 
features <- SelectIntegrationFeatures(object.list = alldata, nfeatures = 4000)
anno <- readRDS("humanAnnotation.rds")
features <- features %>% as.data.frame() %>% setNames("gene") %>% left_join(., anno[, c(1,3)], by=c("gene"="external_gene_name")) %>% 
  filter(gene_biotype == "protein_coding" | gene_biotype == "lncRNA") %>% distinct(gene) %>% pull(gene)

alldata <- PrepSCTIntegration(object.list = alldata, anchor.features = features)
inteData <- merge(alldata[[1]], y = c(alldata[2:length(alldata)]), merge.data = TRUE)
VariableFeatures(inteData) <- features
rm(alldata);gc()

inteData <- RunPCA(inteData, npcs = 40, assay = "SCT")
ElbowPlot(inteData, ndims = 40)
table(inteData$Sample)
inteData <- RunHarmony(inteData, assay.use = "SCT", reduction = "pca", dims.use = 1:30, group.by.vars = "Sample", plot_convergence = TRUE)

inteData <- RunUMAP(inteData, dims = 1:30, assay = "SCT", reduction = "harmony")
DimPlot(inteData, group.by = "Sample") + NoAxes()

inteData = FindNeighbors(inteData, dims = 1:30, reduction = "harmony", k.param = 30)
inteData = FindClusters(inteData, resolution = 0.5)
inteData = FindClusters(inteData, resolution = 0.8)
DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T)
DimPlot(inteData, group.by = "SCT_snn_res.0.8", label = T, split.by = "Condition")  
DefaultAssay(inteData) <- "RNA"
inteData <- NormalizeData(inteData)

saveRDS(inteData, "step2_DFU_wounds_integration_harmony.rds")

inteData@reductions$pca@assay.used <- "RNA"
inteData@reductions$harmony@assay.used <- "RNA"
inteData@reductions$umap@assay.used <- "RNA"

inteData <- DietSeurat(inteData, assays = "RNA", dimreducs = c("pca", "harmony", "umap"))
saveRDS(inteData, "step2_DFU_wounds_integration_harmony_reduced.rds")
```



```{r}
inteData <- readRDS("step2_DFU_wounds_integration_harmony_reduced.rds")
mt <- data.table::fread("step1_diabetic_foot_ulcers_metadata.txt")
mt_com <- inteData@meta.data %>% rownames_to_column(var = "barcode") %>% select(1, 6, 15)
mt_com_f <- mt_com %>% filter(CellType == "DFU")
identical(mt$barcode, mt_com_f$barcode)
identical(colnames(inteData)[1:72854], mt$barcode)
inteData$CellType[1:72854] <- mt$CellType

DimPlot(inteData, group.by = "Project", cols = c("#d8b365", "#5ab4ac")) + ggtitle("Integration")
DimPlot(inteData, group.by = "Project", split.by = "Project", cols = c("#d8b365", "#5ab4ac")) + ggtitle("Integration")

# human wounds data
wds_fact_lev <- c("Bas-I", "Bas-II", "Bas-prolif", "Bas-mig", 
                  "Spi-I", "Spi-II", "Spi-mig", 
                  "Gra-I", "HF",
                  "MEL", 
                  "FB-I", "FB-II", "FB-III", "FB-prolif", 
                  "Schwann", "PC-vSMC", "LE", "VE", 
                  "NK-cell", "Th", "Plasma_Bcell", "Mast-cell", 
                  "Mono-Mac", "cDC1", "cDC2", "DC3", "LC")

fac_levs <- c("BasalKera", "DiffKera", "OtherKera", "Sweat_Seba", 
              "HE_Fibro", "FB_I_III_DFU", "FB_II_DFU", "SMC1", "SMC2",
              "M1_Macro", "M2_Macro", "B_Lympho", "NKT_Lympho", 
              "LymphEndo", "VasEndo_art", "VasEndo_ven", "Melano_Schwann", "Mast")

all.cl <- c(wds_fact_lev, fac_levs)

ct.cols <- c("#d94701", "#fd8d3c", "#fdbe85", "#33A02C", "#72BF5A", "#B2DF8A", 
                 "#f768a1", "#d4b9da", "#737373", "#0570b0", "#3690c0", "#92c5de", 
                 "#d1e5f0", "#c0a700", "#1a9850", "#fb9a99", "#8d4720", "#35978f", 
                 "#41b6c4", "#80cdc1", "#df65b0", "#dd3497", "#807dba", "#6a3d9a",
                 "#9e9ac8", "#b15928",
                 "#d94701", "#fd8d3c", "#fdbe85", "#33A02C", "#72BF5A", "#B2DF8A", 
                 "#f768a1", "#d4b9da", "#737373", "#0570b0", "#3690c0", "#92c5de", 
                 "#d1e5f0", "#c0a700", "#1a9850", "#fb9a99", "#8d4720", "#35978f",  "#41b6c4"
)


# set the cluster and colors
inteData$CellType <- factor(inteData$CellType, levels = all.cl)
inteData$Condition <- factor(inteData$Condition, levels = c("Skin", "Wound1", "Wound7", "Wound30", "H", "DFU_H", "DFU_NH"))

DimPlot(inteData, group.by = "CellType", label = T, cols = ct.cols, label.size = 4, split.by = "Project") + ggtitle("")
DimPlot(inteData, group.by = "CellType", label = T, cols = ct.cols,  label.size = 3, split.by = "Condition", ncol = 4) + ggtitle("") + NoLegend()


Bas_mig <- WhichCells(inteData, idents = c("Bas-mig"))
Spi_mig <- WhichCells(inteData, idents = c("Spi-mig"))
DimPlot(inteData, group.by = "CellType", cells.highlight=list(Bas_mig=Bas_mig, Spi_mig=Spi_mig), cols.highlight = c("#B2DF8A", "#fdbe85"), cols= "grey", split.by = "Condition", ncol = 3) + ggtitle("")

```



# SessionInfo
```{r}
sessionInfo()
```

