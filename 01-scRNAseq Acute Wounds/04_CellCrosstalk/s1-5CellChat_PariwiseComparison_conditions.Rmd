---
title: "CellChat analysis across conditions"
author: "Zhuang Liu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true #add a table of contents (TOC)
    toc_depth: 3 #headers' level in the toc
    toc_float: true #toc visible even when scrolled
    theme: lumen
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center', fig.width=12, warning=FALSE, message=FALSE)
```

#####################################
# Part 1: Data loading and comparing

## a. Load the required libraries and data
```{r warning=FALSE, message=FALSE}
library(CellChat)
library(patchwork)
library(Seurat)
library(tidyverse)
options(stringsAsFactors = FALSE)

conditions = c("Skin", "Wound1", "Wound7", "Wound30")

alldata = list()
for (cond in conditions) {
    savefile2 = paste0("./cellchat_all_L-R_", cond, ".rds")
    alldata[[cond]] = readRDS(file = savefile2)
}
alldata <- lapply(alldata, updateCellChat) # Update the objects since the cellchat was updated after my analysis
alldata_ori <- alldata # make a copy
```

## b. Compare general interactions
### I. Heatmap of general interaction
```{r fig.height=8}
library(ComplexHeatmap)
library(circlize)
library(viridis)
library(RColorBrewer)

# Sets the minimum, the maximum, and the increasing steps for the color scale
# Note: if some of your genes are outside of this range, they will appear white on the heatmap

for (cond in conditions) {
  p1 <- Heatmap(alldata[[cond]]@net$weight,
        column_title = cond,
        row_title="Ligand sender cell types",
        name = 'Strength of \ninteractions',
        border = T,
        col= colorRamp2(c(0,1,2,3,4,5,6),c('white','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8')),
        cluster_rows = F, cluster_columns = F,
        #cluster methods
        show_column_names = TRUE, show_row_names = TRUE,
        use_raster = FALSE, 
        row_gap = unit(0, 'cm'),
        column_gap = unit(0, 'cm'),
        heatmap_legend_param = list(legend_direction=c("vertical"),
                                    at = c(0,1,2,3,4,5,6)))
  print(p1)
}

for (cond in conditions) {
  p1 <- Heatmap(alldata[[cond]]@net$count,
        column_title = cond,
        row_title="Ligand sender cell types",
        name = 'Total number \nof interactions',
        border = T,
        col= colorRamp2(c(0,30,60,90,120,150,180),c('white','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8')),
        cluster_rows = F, cluster_columns = F,
        #cluster methods
        show_column_names = TRUE, show_row_names = TRUE,
        use_raster = FALSE, 
        row_gap = unit(0, 'cm'),
        column_gap = unit(0, 'cm'),
        heatmap_legend_param = list(legend_direction=c("vertical"),
                                    at = c(0,30,60,90,120,150,180)))
  print(p1)
}

conditions
skin <- alldata[["Skin"]]@net$count
wound1 <- alldata[["Wound1"]]@net$count
wound7 <- alldata[["Wound7"]]@net$count
wound30 <- alldata[["Wound30"]]@net$count

ct <- data.frame(Skin_MonoMac = skin[1:7,22], Wound1_MonoMac = wound1[1:7, 22],
                 Wound7_MonoMac = wound7[1:7, 22], Wound30_MonoMac = wound30[1:7, 22])
ct <- data.frame(Skin = skin[22, 1:7], Wound1 = wound1[22, 1:7],
                 Wound7 = wound7[22, 1:7], Wound30 = wound30[22, 1:7])
Heatmap(ct,
        row_title="",
        name = 'Total number \nof interactions',
        border = T,
        col= colorRamp2(c(0,8,16,24,32,40,48),c('white','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8')),
        cluster_rows = F, cluster_columns = F,
        #cluster methods
        show_column_names = TRUE, show_row_names = TRUE,
        use_raster = FALSE, 
        row_gap = unit(0, 'cm'),
        column_gap = unit(0, 'cm'),
        heatmap_legend_param = list(legend_direction=c("vertical"),
                                    at = c(0,8,16,24,32,40,48)))
```

### II. Plot top signaling pathways
```{r fig.height=6}
create_mean_df = function(x) {
    mat = x@netP$prob
    dfm = data.frame(mean.prob = apply(mat, 3, mean), max.prob = apply(mat, 3, max)) # apply(x, 3, fun) used in array data of multi-dimension
    #dfm = dfm[order(dfm$mean.prob, decreasing = T), ]
    dfm = dfm[order(dfm$max.prob, decreasing = T), ]
    return(dfm)
}
dfm = lapply(alldata, create_mean_df)

all.top = unique(unlist(lapply(dfm, function(x) head(rownames(x), 10))))

cat("Top signaling pathways based on top 10 max.probability:\n", all.top)

for (pw in all.top) {
    plots = list()
    for (ds in names(alldata)) {
        plots[[paste0(pw, "-", ds)]] = netAnalysis_signalingRole_scatter(alldata[[ds]],
            signaling = pw) + ggtitle(paste0(pw, "-", ds))
    }
    gridExtra::grid.arrange(grobs = plots, ncol = 2)
}
```


################################################
# Part 2: Pairwise comparison across conditions

## a. Skin (Control) vs. Wound1 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Skin"]]@idents), levels(alldata[["Wound1"]]@idents))
#alldata[["Skin"]] <- liftCellChat(alldata[["Wound1"]], group.new) #Lift up using the cell types
object.list <- list(Skin = alldata[["Skin"]], Wound1 = alldata[["Wound1"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
    plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

# export the bas/spi-mig clusters (EGF signaling pathway)
```{r fig.height=38}
pdf("Bas_Spin_mig_wound1_vs_skin.pdf", useDingbats = F, width = 8, height = 3)
patchwork::wrap_plots(plots = plots[c(3,6)], ncol = 2) + plot_layout(guides = "collect")
dev.off()

# circle plots
object.list.all <- list(Skin = alldata_ori[["Skin"]], 
                        Wound1 = alldata_ori[["Wound1"]],
                        Wound7 = alldata_ori[["Wound7"]], 
                        Wound30 = alldata_ori[["Wound30"]])

allcount_group1 <- object.list.all[[1]]@net[["count"]]
allcount_group2 <- object.list.all[[2]]@net[["count"]]
allcount_group3 <- object.list.all[[3]]@net[["count"]]
allcount_group4 <- object.list.all[[4]]@net[["count"]]

# calculate the total number of interactions of ligands and receptors
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
group3_nInt <- colSums(allcount_group3) + rowSums(allcount_group3)
group4_nInt <- colSums(allcount_group4) + rowSums(allcount_group4)

nodesize <- list(group1=group1_nInt, group2=group2_nInt,
                 group3=group3_nInt, group4=group4_nInt)

nodecolor <- c("#d94701", "#fd8d3c", "#fdbe85", #Basal clusters
             "#33A02C", "#72BF5A", "#B2DF8A", #Spinous clusters
             "#f768a1", "#d4b9da", #Granular, Hair follicle
             "#737373", #MEL
             "#0570b0", "#3690c0", "#92c5de", "#d1e5f0", #Fibroblast clusters
             "#c0a700", "#1a9850", "#fb9a99", "#8d4720",  # Schwann,PCvSMC,LE,VE
             "#35978f", "#41b6c4", "#80cdc1","#df65b0", #"NK-cell", "Th", "Plasma_Bcell", "Mast-cell", 
             "#dd3497", "#807dba","#6a3d9a","#9e9ac8", "#b15928" #"Mono-Mac", "cDC1", "cDC2", "DC3", "LC"
)


pathways.show.all <- c("EGF")
for (i in seq_along(pathways.show.all)) {
  pathways.show <- pathways.show.all[i] #PDGF, VEGF
  weight.max <- getMaxWeight(object.list.all, slot.name = c("netP"), attribute = pathways.show) #   control the edge weights across different datasets
  io.idex = which(levels(object.list.all[[1]]@idents) %in% c("Bas-mig", "Spi-mig"))
  
  #pdf("THBS_FB.pdf", useDingbats = F, width = 12, height = 12)
  par(mfrow = c(1,2), xpd=TRUE)
  for (i in 1:length(object.list.all)) {
    netVisual_aggregate(object.list.all[[i]], signaling = pathways.show, layout = "circle", 
                        #sources.use = io.idex, # only care for the ligands from interested clusters
                        #targets.use = io.idex, # only care for the receptors from interested clusters
                        idents.use = c(3,6), # both ligands and receptors from interested clusters
                        edge.weight.max = weight.max[1], edge.width.max = 10, 
                        signaling.name = paste(pathways.show, names(object.list.all)[i]), 
                        thresh = 0.01, show.legend = T, arrow.size = 0.1,
                        vertex.weight = nodesize[[i]], 
                        vertex.weight.max = max(unlist(nodesize)),
                        color.use = nodecolor)
  }
  #dev.off()
  
  # draw the violin plot
  cellchat <- mergeCellChat(object.list.all, add.names = names(object.list.all))
  cellchat@meta$datasets = factor(cellchat@meta$datasets, levels = c("Skin", "Wound1", "Wound7", "Wound30")) 
  
  print(plotGeneExpression(cellchat, signaling = pathways.show, split.by = "datasets", colors.ggplot = T))
}

```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## b. Wound1 (Control) vs. Wound7 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Wound1"]]@idents), levels(alldata[["Wound7"]]@idents))
#alldata[["Wound1"]] <- liftCellChat(alldata[["Wound7"]], group.new) #Lift up using the cell types
object.list <- list(Wound1 = alldata[["Wound1"]], Wound7 = alldata[["Wound7"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
  plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## c. Wound7 (Control) vs. Wound30 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Wound7"]]@idents), levels(alldata[["Wound30"]]@idents))
#alldata[["Wound7"]] <- liftCellChat(alldata[["Wound30"]], group.new) #Lift up using the cell types
object.list <- list(Wound7 = alldata[["Wound7"]], Wound30 = alldata[["Wound30"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
  plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## d. Wound1 (Control) vs. Wound30 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Wound1"]]@idents), levels(alldata[["Wound30"]]@idents))
#alldata[["Wound1"]] <- liftCellChat(alldata[["Wound30"]], group.new) #Lift up using the cell types
object.list <- list(Wound1 = alldata[["Wound1"]], Wound30 = alldata[["Wound30"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
  plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## e. Skin (Control) vs. Wound30 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Skin"]]@idents), levels(alldata[["Wound30"]]@idents))
#alldata[["Skin"]] <- liftCellChat(alldata[["Wound30"]], group.new) #Lift up using the cell types
object.list <- list(Skin = alldata[["Skin"]], Wound30 = alldata[["Wound30"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
  plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## f. Skin (Control) vs. Wound7 (Test)

```{r}
# Define the cell labels to lift up
#group.new = union(levels(alldata[["Skin"]]@idents), levels(alldata[["Wound7"]]@idents))
#alldata[["Skin"]] <- liftCellChat(alldata[["Wound7"]], group.new) #Lift up using the cell types
object.list <- list(Skin = alldata[["Skin"]], Wound7 = alldata[["Wound7"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)
```

```{r fig.height=8}
print("The number and strength of interactions in each group")
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")
gg1 + gg2

#print("The differential number of interaction in each group")
#par(mfrow = c(1,2), xpd=TRUE)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)
#netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight", arrow.size = 0,
#                          vertex.weight.max = 20, vertex.size.max = 10, edge.width.max = 6)

print("The differential number of interaction in each group (Heatmap")
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
gg1 + gg2

allcount_group1 <- object.list[[1]]@net[["count"]]
allcount_group2 <- object.list[[2]]@net[["count"]]
# sum up all the interactions among cell types: 
# colSum means total interaction numbers of receptor
# rowSum means total interaction numbers of ligand
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
nodesize <- list(group1=group1_nInt, group2=group2_nInt)

weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], 
                   edge.width.max = 6, 
                   title.name = paste0("Number of interactions - ", names(object.list)[i]), 
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}

weight.max <- getMaxWeight(object.list, attribute = c("idents","weight"))
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$weight, weight.scale = T, label.edge= F, 
                   edge.weight.max = weight.max[2], edge.width.max = 6, 
                   title.name = paste0("Strength of interactions - ", names(object.list)[i]),
                   arrow.size = 0, vertex.weight = nodesize[[i]])
}
```

```{r fig.height=8}
print("Compare the major sources and targets in each groupthe outgoing and incoming interaction strength in 2D space")
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
patchwork::wrap_plots(plots = gg)
```

```{r fig.height=38}
cat("For each newCellTypes plot the signalling changes of all pathways, both incoming and outgoing.\n\n")
group.new = colnames(cellchat@net[[1]]$count)

plots = list()
for (ct in group.new) {
  plots[[ct]] <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = ct)
}
patchwork::wrap_plots(plots = plots, ncol = 2)
```

```{r fig.height=15}
gg1 <- rankNet(cellchat, mode = "comparison", stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", stacked = F, do.stat = TRUE)
gg1 + gg2
```


```{r fig.width=12, fig.height=10}
# split kera and immune and save to vectors
m = cellchat@meta
s = lapply(split(m$newCellTypes, m$newMainCellTypes), unique)

kera = as.character(s$Keratinocyte)
fibro = as.character(s$Fibroblast)
immune_m = as.character(c(s$Myeloid))
immune_t = as.character(c(s$Lymphoid))

# get the index of each main cell type
cellchat@idents = cellchat@meta$newCellTypes
kera.idx = which(levels(cellchat@idents) %in% kera)
fibro.idx = which(levels(cellchat@idents) %in% fibro)
immune_m.idx = which(levels(cellchat@idents) %in% immune_m)
immune_t.idx = which(levels(cellchat@idents) %in% immune_t)

signal_io <- c("CCL", "CXCL", "LAMININ", "COLLAGEN", "WNT")

print("Keratinocyte (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T) 

print("Keratinocyte (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Keratinocyte (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = kera.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Myeloid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_m.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Fibroblast (Ligand) to Lymphoid cells (Receptor)")
netVisual_bubble(cellchat, sources.use = fibro.idx, targets.use = immune_t.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Myeloid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_m.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Keratinocyte (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = kera.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)

print("Lymphoid cells (Ligand) to Fibroblast (Receptor)")
netVisual_bubble(cellchat, sources.use = immune_t.idx, targets.use = fibro.idx, comparison = c(1, 2), angle.x = 45, thresh = 0.001, signaling = signal_io, remove.isolate = T)
```


## Final chord diagram
```{r eval=FALSE}
object.list.all <- list(Skin = alldata_ori[["Skin"]], 
                        Wound1 = alldata_ori[["Wound1"]],
                        Wound7 = alldata_ori[["Wound7"]], 
                        Wound30 = alldata_ori[["Wound30"]])

num.link <- sapply(object.list.all, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list.all)) {
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list.all[[i]], title = names(object.list.all)[i], weight.MinMax = weight.MinMax)
}
wrap_plots(plots = gg) + plot_layout(guide = "collect")

allcount_group1 <- object.list.all[[1]]@net[["count"]]
allcount_group2 <- object.list.all[[2]]@net[["count"]]
allcount_group3 <- object.list.all[[3]]@net[["count"]]
allcount_group4 <- object.list.all[[4]]@net[["count"]]

# calculate the total number of interactions of ligands and receptors
group1_nInt <- colSums(allcount_group1) + rowSums(allcount_group1)
group2_nInt <- colSums(allcount_group2) + rowSums(allcount_group2)
group3_nInt <- colSums(allcount_group3) + rowSums(allcount_group3)
group4_nInt <- colSums(allcount_group4) + rowSums(allcount_group4)

nodesize <- list(group1=group1_nInt, group2=group2_nInt,
                 group3=group3_nInt, group4=group4_nInt)

pathways.show <- "PDGF" #PDGF, VEGF
weight.max <- getMaxWeight(object.list.all, slot.name = c("netP"), attribute = pathways.show) # control the edge weights across different datasets
io.idex = which(levels(object.list.all[[1]]@idents) %in% c("Bas-mig", "Spi-mig"))

#pdf("THBS_FB.pdf", useDingbats = F, width = 12, height = 12)
par(mfrow = c(2,2), xpd=TRUE)
for (i in 1:length(object.list.all)) {
  netVisual_aggregate(object.list.all[[i]], signaling = pathways.show, layout = "circle", 
                      #sources.use = io.idex, # only care for the ligands from interested clusters
                      #targets.use = io.idex, # only care for the receptors from interested clusters
                      idents.use = io.idex, # both ligands and receptors from interested clusters
                      edge.weight.max = weight.max[1], edge.width.max = 15, 
                      signaling.name = paste(pathways.show, names(object.list.all)[i]), 
                      thresh = 0.01, show.legend = T, arrow.size = 0.1,
                      vertex.weight = nodesize[[i]], vertex.weight.max = max(unlist(nodesize)))
}
#dev.off()

# draw the violin plot
cellchat <- mergeCellChat(object.list.all, add.names = names(object.list.all))
cellchat@meta$datasets = factor(cellchat@meta$datasets, levels = c("Skin", "Wound1", "Wound7", "Wound30")) 

plotGeneExpression(cellchat, signaling = pathways.show, split.by = "datasets", colors.ggplot = T)
```

# Compare outgoing (or incoming) signaling associated with each cell population
```{r eval=FALSE}
library(ComplexHeatmap)
object.list <- list(Skin = alldata[["Skin"]], Wound1 = alldata[["Wound1"]])
cellchat <- mergeCellChat(object.list, add.names = names(object.list))#, cell.prefix = TRUE)

i=1

# combining all the identified signaling pathways from different datasets 
#pathway.union <- union(object.list[[i]]@netP$pathways, object.list[[i+1]]@netP$pathways)
pathway.union <- c("EGF", "PARs", "THBS", "COLLAGEN", "FN1")
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6)
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))

ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6, color.heatmap = "GnBu")
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6, color.heatmap = "GnBu")
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))

ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "all", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6, color.heatmap = "OrRd")
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "all", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6, color.heatmap = "OrRd")
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
```


# SessionInfo
```{r}
sessionInfo()
```
